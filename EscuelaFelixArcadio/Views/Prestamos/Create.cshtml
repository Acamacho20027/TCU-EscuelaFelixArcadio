@model EscuelaFelixArcadio.Models.Prestamo

@{
    ViewBag.Title = "Crear Prestamo";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/prestamos.css" rel="stylesheet" />
}

<div class="prestamos-container">
    <div class="prestamos-form-container">
        <h2 class="prestamos-form-title">Crear Nuevo Prestamo</h2>

        @using (Html.BeginForm("Create", "Prestamos", FormMethod.Post, new { @class = "prestamos-form" }))
        {
            @Html.AntiForgeryToken()
            
            @Html.ValidationSummary(true, "", new { @class = "prestamos-alert prestamos-alert-error" })

            <div class="prestamos-form-section">
                <h3 class="prestamos-form-section-title">Informacion del Prestamo</h3>
                
                <div class="prestamos-form-grid">
                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.NumeroPrestamo, "Numero de Prestamo", new { @class = "prestamos-form-label" })
                        @Html.TextBoxFor(model => model.NumeroPrestamo, new { @class = "prestamos-form-control", placeholder = "Se genera automaticamente si se deja vacio", data_val = "false" })
                        @Html.ValidationMessageFor(model => model.NumeroPrestamo, "", new { @class = "text-danger" })
                    </div>

                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.Id, "Usuario", new { @class = "prestamos-form-label" })
                        @Html.DropDownList("Id", null, "Seleccione un usuario", new { @class = "prestamos-form-control", required = "required" })
                        @Html.ValidationMessageFor(model => model.Id, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="prestamos-form-grid">
                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.IdEstado, "Estado", new { @class = "prestamos-form-label" })
                        @Html.DropDownList("IdEstado", null, "Seleccione un estado", new { @class = "prestamos-form-control", required = "required" })
                        @Html.ValidationMessageFor(model => model.IdEstado, "", new { @class = "text-danger" })
                    </div>

                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.Devolucion, "Estado de Devolucion", new { @class = "prestamos-form-label" })
                        <select name="Devolucion" class="prestamos-form-control">
                            <option value="false">No</option>
                            <option value="true">Si</option>
                        </select>
                        @Html.ValidationMessageFor(model => model.Devolucion, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="prestamos-form-grid">
                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.DuracionEstimada, "Duracion Estimada (dias)", new { @class = "prestamos-form-label" })
                        @Html.TextBoxFor(model => model.DuracionEstimada, new { @class = "prestamos-form-control", type = "number", min = "1", max = "365", placeholder = "Ej: 7 dias" })
                        @Html.ValidationMessageFor(model => model.DuracionEstimada, "", new { @class = "text-danger" })
                    </div>

                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.FechaVencimiento, "Fecha de Vencimiento", new { @class = "prestamos-form-label" })
                        @Html.TextBoxFor(model => model.FechaVencimiento, new { @class = "prestamos-form-control", type = "date" })
                        @Html.ValidationMessageFor(model => model.FechaVencimiento, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="prestamos-form-grid">
                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.MotivoPrestamo, "Motivo del Prestamo", new { @class = "prestamos-form-label" })
                        @Html.TextBoxFor(model => model.MotivoPrestamo, new { @class = "prestamos-form-control", placeholder = "Ej: Clase de futbol, Entrenamiento, Evento" })
                        @Html.ValidationMessageFor(model => model.MotivoPrestamo, "", new { @class = "text-danger" })
                    </div>

                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.EsUrgente, "Es Urgente", new { @class = "prestamos-form-label" })
                        <select name="EsUrgente" class="prestamos-form-control">
                            <option value="false">No</option>
                            <option value="true">Si</option>
                        </select>
                        @Html.ValidationMessageFor(model => model.EsUrgente, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="prestamos-form-grid">
                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.FechaInicioUso, "Fecha de Inicio de Uso", new { @class = "prestamos-form-label" })
                        @Html.TextBoxFor(model => model.FechaInicioUso, new { @class = "prestamos-form-control", type = "date" })
                        @Html.ValidationMessageFor(model => model.FechaInicioUso, "", new { @class = "text-danger" })
                    </div>

                    <div class="prestamos-form-group">
                        @Html.LabelFor(model => model.FechaFinUso, "Fecha de Fin de Uso", new { @class = "prestamos-form-label" })
                        @Html.TextBoxFor(model => model.FechaFinUso, new { @class = "prestamos-form-control", type = "date" })
                        @Html.ValidationMessageFor(model => model.FechaFinUso, "", new { @class = "text-danger" })
                    </div>
                </div>
            </div>

            <div class="prestamos-form-section">
                <h3 class="prestamos-form-section-title">Informacion Adicional</h3>
                
                <div class="prestamos-form-group">
                    @Html.LabelFor(model => model.Notas, "Notas u Observaciones", new { @class = "prestamos-form-label" })
                    @Html.TextAreaFor(model => model.Notas, new { @class = "prestamos-form-control", rows = 4, placeholder = "Ingrese notas u observaciones del prestamo (opcional)" })
                    @Html.ValidationMessageFor(model => model.Notas, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="prestamos-form-buttons">
                <button type="submit" class="btn-prestamos-save">
                    <i class="fas fa-plus"></i> Crear Prestamo
                </button>
                <a href="@Url.Action("Index", "Prestamos")" class="btn-prestamos-cancel">
                    Regresar a la Lista
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    
    <script>
        $(document).ready(function() {
            // Deshabilitar validación del lado del cliente para NumeroPrestamo
            $('input[name="NumeroPrestamo"]').removeAttr('data-val-required');
            
            // Limpiar cualquier error existente
            $('[data-valmsg-for="NumeroPrestamo"]').text('');
            $('input[name="NumeroPrestamo"]').removeClass('input-validation-error');
            
            // Validación para solo permitir números en NumeroPrestamo
            $('input[name="NumeroPrestamo"]').on('input', function() {
                var value = $(this).val();
                // Remover cualquier carácter que no sea número
                var numericValue = value.replace(/[^0-9]/g, '');
                $(this).val(numericValue);
                
                // Limpiar errores si hay contenido válido
                if (numericValue !== '') {
                    $('[data-valmsg-for="NumeroPrestamo"]').text('');
                    $(this).removeClass('input-validation-error');
                }
            });
            
            // Prevenir pegar contenido no numérico
            $('input[name="NumeroPrestamo"]').on('paste', function(e) {
                setTimeout(function() {
                    var value = $('input[name="NumeroPrestamo"]').val();
                    var numericValue = value.replace(/[^0-9]/g, '');
                    $('input[name="NumeroPrestamo"]').val(numericValue);
                }, 10);
            });
            
            // Validación para solo permitir letras en MotivoPrestamo
            $('input[name="MotivoPrestamo"]').on('input', function() {
                var value = $(this).val();
                // Remover cualquier carácter que no sea letra, espacio o acentos
                var lettersOnly = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
                $(this).val(lettersOnly);
                
                // Limpiar errores si hay contenido válido
                if (lettersOnly !== '') {
                    $('[data-valmsg-for="MotivoPrestamo"]').text('');
                    $(this).removeClass('input-validation-error');
                }
            });
            
            // Prevenir pegar contenido no válido en MotivoPrestamo
            $('input[name="MotivoPrestamo"]').on('paste', function(e) {
                setTimeout(function() {
                    var value = $('input[name="MotivoPrestamo"]').val();
                    var lettersOnly = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
                    $('input[name="MotivoPrestamo"]').val(lettersOnly);
                }, 10);
            });
            
            // Calcular fecha de vencimiento automáticamente
            $('input[name="DuracionEstimada"]').on('input', function() {
                var duracion = parseInt($(this).val());
                if (duracion > 0) {
                    var fechaActual = new Date();
                    var fechaVencimiento = new Date(fechaActual.getTime() + (duracion * 24 * 60 * 60 * 1000));
                    var fechaFormateada = fechaVencimiento.toISOString().split('T')[0];
                    $('input[name="FechaVencimiento"]').val(fechaFormateada);
                }
            });
            
            // Interceptar el envío del formulario
            $('form').on('submit', function(e) {
                // Limpiar errores de validación para NumeroPrestamo antes del envío
                $('[data-valmsg-for="NumeroPrestamo"]').text('').removeClass('field-validation-error').addClass('field-validation-valid');
                $('input[name="NumeroPrestamo"]').removeClass('input-validation-error');
                
                // Permitir el envío del formulario
                return true;
            });
        });
    </script>
}
