@model EscuelaFelixArcadio.Models.PlantillaReporte

@{
    ViewBag.Title = "Crear Plantilla de Reporte";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/reportes.css" rel="stylesheet" />
}

<div class="reportes-container">
    <!-- Header -->
    <div class="reportes-header">
        <h1>
            <i class="fas fa-plus header-icon"></i>
            @ViewBag.Title
        </h1>
        <div class="header-subtitle">
            Crea una nueva plantilla de reporte para uso futuro
        </div>
    </div>

    <!-- Formulario de creación -->
    <div class="form-section">
        <div class="filtros-header">
            <i class="fas fa-cog filtros-icon"></i>
            <h3>Configuración de la Plantilla</h3>
        </div>
        
        @using (Html.BeginForm("CrearPlantilla", "Reportes", FormMethod.Post, new { @id = "formPlantilla" }))
        {
            @Html.AntiForgeryToken()
            
            <div class="filtros-grid">
                <div class="filtro-group">
                    @Html.LabelFor(model => model.Nombre, "Nombre de la Plantilla")
                    @Html.TextBoxFor(model => model.Nombre, new { @class = "form-control", @required = "required", @placeholder = "Ej: Inventario Mensual" })
                    @Html.ValidationMessageFor(model => model.Nombre, "", new { @class = "text-danger" })
                </div>
                
                <div class="filtro-group">
                    @Html.LabelFor(model => model.TipoReporte, "Tipo de Reporte")
                    @Html.DropDownListFor(model => model.TipoReporte, new SelectList(new[] {
                        new { Value = "inventario", Text = "Inventario" },
                        new { Value = "prestamos", Text = "Préstamos" },
                        new { Value = "sanciones", Text = "Sanciones" },
                        new { Value = "general", Text = "General" }
                    }, "Value", "Text"), "Seleccionar tipo", new { @class = "form-control", @required = "required" })
                    @Html.ValidationMessageFor(model => model.TipoReporte, "", new { @class = "text-danger" })
                </div>
                
                <div class="filtro-group">
                    @Html.LabelFor(model => model.OrdenVisualizacion, "Orden de Visualización")
                    @Html.TextBoxFor(model => model.OrdenVisualizacion, new { @type = "number", @class = "form-control", @value = "0", @min = "0" })
                    @Html.ValidationMessageFor(model => model.OrdenVisualizacion, "", new { @class = "text-danger" })
                </div>
                
                <div class="filtro-group">
                    @Html.LabelFor(model => model.EsEditable, "Es Editable")
                    @Html.CheckBoxFor(model => model.EsEditable, new { @checked = "checked" })
                    <small class="form-text text-muted">Permite a otros usuarios modificar esta plantilla</small>
                </div>
            </div>
            
            <div class="filtro-group">
                @Html.LabelFor(model => model.Descripcion, "Descripción")
                @Html.TextAreaFor(model => model.Descripcion, new { @class = "form-control", @rows = "3", @placeholder = "Describe qué hace esta plantilla y cuándo usarla" })
                @Html.ValidationMessageFor(model => model.Descripcion, "", new { @class = "text-danger" })
            </div>
            
            <div class="filtro-group">
                @Html.LabelFor(model => model.ConfiguracionJSON, "Configuración JSON")
                @Html.TextAreaFor(model => model.ConfiguracionJSON, new { @class = "form-control", @rows = "8", @placeholder = '{"filtros": ["fechaInicio", "fechaFin"], "columnas": ["Id", "Nombre", "Estado"], "agrupacion": "Categoria"}' })
                @Html.ValidationMessageFor(model => model.ConfiguracionJSON, "", new { @class = "text-danger" })
                <small class="form-text text-muted">
                    Configuración en formato JSON que define filtros, columnas, agrupaciones y otras opciones del reporte.
                </small>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i>
                    Crear Plantilla
                </button>
                <a href="@Url.Action("Plantillas")" class="btn-secondary">
                    <i class="fas fa-times"></i>
                    Cancelar
                </a>
            </div>
        }
    </div>

    <!-- Plantillas de ejemplo -->
    <div class="form-section">
        <div class="filtros-header">
            <i class="fas fa-lightbulb filtros-icon"></i>
            <h3>Plantillas de Ejemplo</h3>
        </div>
        
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-boxes card-icon"></i>
                    Inventario Básico
                </h3>
                <div class="card-description">
                    Plantilla simple para reporte de inventario con filtros básicos.
                </div>
                <button type="button" class="card-action" onclick="cargarEjemplo('inventario-basico')">
                    <i class="fas fa-copy"></i>
                    Usar Ejemplo
                </button>
            </div>

            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-hand-holding card-icon"></i>
                    Préstamos Detallado
                </h3>
                <div class="card-description">
                    Plantilla completa para análisis detallado de préstamos.
                </div>
                <button type="button" class="card-action" onclick="cargarEjemplo('prestamos-detallado')">
                    <i class="fas fa-copy"></i>
                    Usar Ejemplo
                </button>
            </div>

            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-exclamation-triangle card-icon"></i>
                    Sanciones Activas
                </h3>
                <div class="card-description">
                    Plantilla para reporte de sanciones activas con análisis.
                </div>
                <button type="button" class="card-action" onclick="cargarEjemplo('sanciones-activas')">
                    <i class="fas fa-copy"></i>
                    Usar Ejemplo
                </button>
            </div>

            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-chart-line card-icon"></i>
                    Resumen Ejecutivo
                </h3>
                <div class="card-description">
                    Plantilla para resumen ejecutivo con métricas clave.
                </div>
                <button type="button" class="card-action" onclick="cargarEjemplo('resumen-ejecutivo')">
                    <i class="fas fa-copy"></i>
                    Usar Ejemplo
                </button>
            </div>
        </div>
    </div>

    <!-- Ayuda -->
    <div class="form-section">
        <div class="filtros-header">
            <i class="fas fa-question-circle filtros-icon"></i>
            <h3>Ayuda - Formato JSON</h3>
        </div>
        
        <div class="alertas-container">
            <div class="alerta-item media">
                <i class="fas fa-info-circle alerta-icon"></i>
                <div class="alerta-content">
                    <div class="alerta-titulo">Estructura JSON Básica</div>
                    <div class="alerta-descripcion">
                        <pre>{
  "filtros": ["fechaInicio", "fechaFin", "usuarios", "estados"],
  "columnas": ["Id", "Nombre", "Estado", "Fecha"],
  "agrupacion": "Categoria",
  "ordenamiento": "Nombre",
  "metricas": ["total", "promedio", "suma"]
}</pre>
                    </div>
                </div>
            </div>
            
            <div class="alerta-item baja">
                <i class="fas fa-lightbulb alerta-icon"></i>
                <div class="alerta-content">
                    <div class="alerta-titulo">Tipos de Filtros Disponibles</div>
                    <div class="alerta-descripcion">
                        <ul>
                            <li><strong>fechaInicio, fechaFin:</strong> Filtros de fecha</li>
                            <li><strong>usuarios:</strong> Filtro por usuarios específicos</li>
                            <li><strong>estados:</strong> Filtro por estados</li>
                            <li><strong>categorias:</strong> Filtro por categorías</li>
                            <li><strong>tipos:</strong> Filtro por tipos específicos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Configurar formulario
            $('#formPlantilla').on('submit', function(e) {
                // Validar JSON
                var configJSON = $('#ConfiguracionJSON').val();
                if (configJSON && configJSON.trim() !== '') {
                    try {
                        JSON.parse(configJSON);
                    } catch (error) {
                        e.preventDefault();
                        alert('Error en el formato JSON: ' + error.message);
                        return false;
                    }
                }
            });
            
            // Auto-completar desde URL si hay parámetros
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('nombre')) {
                $('#Nombre').val(urlParams.get('nombre'));
            }
            if (urlParams.get('descripcion')) {
                $('#Descripcion').val(urlParams.get('descripcion'));
            }
            if (urlParams.get('tipoReporte')) {
                $('#TipoReporte').val(urlParams.get('tipoReporte'));
            }
            if (urlParams.get('configuracionJSON')) {
                $('#ConfiguracionJSON').val(urlParams.get('configuracionJSON'));
            }
        });

        function cargarEjemplo(tipo) {
            var ejemplos = {
                'inventario-basico': {
                    nombre: 'Inventario Básico',
                    descripcion: 'Reporte básico de inventario con filtros de fecha y categoría',
                    tipoReporte: 'inventario',
                    configuracionJSON: JSON.stringify({
                        filtros: ['fechaInicio', 'fechaFin', 'categorias', 'estados'],
                        columnas: ['IdInventario', 'Producto', 'Codigo', 'Categoria', 'Estado', 'Cantidad', 'Minimo', 'Maximo'],
                        agrupacion: 'Categoria',
                        ordenamiento: 'Producto',
                        alertas: ['stockBajo']
                    }, null, 2)
                },
                'prestamos-detallado': {
                    nombre: 'Préstamos Detallado',
                    descripcion: 'Análisis detallado de préstamos con métricas avanzadas',
                    tipoReporte: 'prestamos',
                    configuracionJSON: JSON.stringify({
                        filtros: ['fechaInicio', 'fechaFin', 'usuarios', 'estados', 'devueltos'],
                        columnas: ['IdPrestamo', 'NumeroPrestamo', 'Usuario', 'Estado', 'FechadeCreacion', 'FechaDevolucion', 'DiasRetraso'],
                        agrupacion: 'Usuario',
                        ordenamiento: 'FechadeCreacion',
                        metricas: ['totalPrestamos', 'tasaDevolucion', 'promedioDuracion']
                    }, null, 2)
                },
                'sanciones-activas': {
                    nombre: 'Sanciones Activas',
                    descripcion: 'Reporte de sanciones activas con análisis de montos',
                    tipoReporte: 'sanciones',
                    configuracionJSON: JSON.stringify({
                        filtros: ['fechaInicio', 'fechaFin', 'usuarios', 'tipos'],
                        columnas: ['IdSancion', 'Usuario', 'Tipo', 'Motivo', 'Monto', 'FechaInicio', 'SancionActiva'],
                        agrupacion: 'Tipo',
                        ordenamiento: 'Monto',
                        metricas: ['totalSanciones', 'montoTotal', 'promedioMonto']
                    }, null, 2)
                },
                'resumen-ejecutivo': {
                    nombre: 'Resumen Ejecutivo',
                    descripcion: 'Resumen ejecutivo con métricas clave del sistema',
                    tipoReporte: 'general',
                    configuracionJSON: JSON.stringify({
                        filtros: ['fechaInicio', 'fechaFin'],
                        metricas: ['totalPrestamos', 'prestamosActivos', 'totalSanciones', 'alertasCriticas', 'productosStockBajo'],
                        graficos: ['barras', 'pie', 'lineas'],
                        formato: 'ejecutivo'
                    }, null, 2)
                }
            };

            var ejemplo = ejemplos[tipo];
            if (ejemplo) {
                $('#Nombre').val(ejemplo.nombre);
                $('#Descripcion').val(ejemplo.descripcion);
                $('#TipoReporte').val(ejemplo.tipoReporte);
                $('#ConfiguracionJSON').val(ejemplo.configuracionJSON);
                
                // Scroll al formulario
                $('html, body').animate({
                    scrollTop: $('#formPlantilla').offset().top - 100
                }, 500);
            }
        }
    </script>
}