@model List<EscuelaFelixArcadio.Models.ViewModels.ReportePrestamosViewModel>

@{
    ViewBag.Title = "Reportes de Préstamos";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/reportes.css?v=3.4" rel="stylesheet" />
}

<div class="reportes-container">
    <!-- Header -->
    <div class="reportes-header" style="display: flex; align-items: center; justify-content: space-between;">
        <a href="@Url.Action("Index", "Reportes")" class="btn-reservas-cancel">
            <i class="fas fa-arrow-left"></i> Volver a Reportes
        </a>
        <h1 class="reportes-title" style="margin: 0;">@ViewBag.Title</h1>
        <div style="width: 200px;"></div>
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
        <!-- Barra de búsqueda -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar por usuario, motivo, estado..." />
        </div>
        
        @using (Html.BeginForm("Prestamos", "Reportes", FormMethod.Get, new { @class = "filtros-form", @id = "filtrosForm" }))
        {
            <!-- Primera fila de filtros -->
            <div class="filtros-row">
                <div class="filtro-group">
                    <label for="usuarios">Usuario</label>
                    <select id="usuarios" name="usuarios" onchange="aplicarFiltros()">
                        <option value="">Todos los usuarios</option>
                        @if (ViewBag.Usuarios != null)
                        {
                            foreach (var usuario in (List<EscuelaFelixArcadio.Models.ApplicationUser>)ViewBag.Usuarios)
                            {
                                <option value="@usuario.Id" @(Request.QueryString["usuarios"] == usuario.Id ? "selected" : "")>@usuario.UserName</option>
                            }
                        }
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="estados">Estado</label>
                    <select id="estados" name="estados" onchange="aplicarFiltros()">
                        <option value="">Todos los estados</option>
                        <option value="Activo" @(Request.QueryString["estados"] == "Activo" ? "selected" : "")>Activo</option>
                        <option value="Inactivo" @(Request.QueryString["estados"] == "Inactivo" ? "selected" : "")>Inactivo</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="devueltos">Devueltos</label>
                    <select id="devueltos" name="devueltos" onchange="aplicarFiltros()">
                        <option value="">Todos</option>
                        <option value="true" @(Request.QueryString["devueltos"] == "true" ? "selected" : "")>Devueltos</option>
                        <option value="false" @(Request.QueryString["devueltos"] == "false" ? "selected" : "")>Pendientes</option>
                    </select>
                </div>
            </div>
            
            <!-- Segunda fila de filtros -->
            <div class="filtros-row">
                <div class="filtro-group">
                    <label for="fechaInicio">Fecha Inicio</label>
                    <input type="date" id="fechaInicio" name="fechaInicio" value="@Request.QueryString["fechaInicio"]" onchange="aplicarFiltros()" />
                </div>
                
                <div class="filtro-group">
                    <label for="fechaFin">Fecha Fin</label>
                    <input type="date" id="fechaFin" name="fechaFin" value="@Request.QueryString["fechaFin"]" onchange="aplicarFiltros()" />
                </div>
                
                <div class="filtro-group">
                    <label for="sortBy">Ordenar por:</label>
                    <select id="sortBy" name="sortBy" onchange="aplicarFiltros()">
                        <option value="Usuario" @(Request.QueryString["sortBy"] == "Usuario" ? "selected" : "")>Usuario</option>
                        <option value="FechaPrestamo" @(Request.QueryString["sortBy"] == "FechaPrestamo" ? "selected" : "")>Fecha Préstamo</option>
                        <option value="FechaDevolucion" @(Request.QueryString["sortBy"] == "FechaDevolucion" ? "selected" : "")>Fecha Devolución</option>
                        <option value="Estado" @(Request.QueryString["sortBy"] == "Estado" ? "selected" : "")>Estado</option>
                        <option value="NumeroPrestamo" @(Request.QueryString["sortBy"] == "NumeroPrestamo" ? "selected" : "")>Número Préstamo</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="sortOrder">Orden:</label>
                    <select id="sortOrder" name="sortOrder" onchange="aplicarFiltros()">
                        <option value="asc" @(Request.QueryString["sortOrder"] == "asc" ? "selected" : "")>Ascendente</option>
                        <option value="desc" @(Request.QueryString["sortOrder"] == "desc" ? "selected" : "")>Descendente</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="pageSize">Mostrar:</label>
                    <select id="pageSize" name="pageSize" onchange="aplicarFiltros()">
                        <option value="10" @(Request.QueryString["pageSize"] == "10" ? "selected" : "")>10</option>
                        <option value="25" @(Request.QueryString["pageSize"] == "25" ? "selected" : "")>25</option>
                        <option value="50" @(Request.QueryString["pageSize"] == "50" ? "selected" : "")>50</option>
                        <option value="100" @(Request.QueryString["pageSize"] == "100" ? "selected" : "")>100</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <button type="button" class="btn-limpiar-filtros" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Datos del Reporte -->
    <div class="datos-section">
        <div class="datos-header">
            <h3>
                <i class="fas fa-table"></i>
                Datos de Préstamos
            </h3>
            <div class="datos-actions">
                <a href="@Url.Action("ExportarPDF", new { tipoReporte = "prestamos", filtros = Request.QueryString.ToString() })" class="btn-exportar">
                    <i class="fas fa-file-pdf"></i>
                    Exportar PDF
                </a>
                <a href="@Url.Action("ExportarExcel", new { tipoReporte = "prestamos", filtros = Request.QueryString.ToString() })" class="btn-exportar btn-excel">
                    <i class="fas fa-file-excel"></i>
                    Exportar Excel
                </a>
            </div>
        </div>
        
        <!-- Cards Grid -->
        <div class="prestamos-cards-grid">
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <div class="prestamos-card">
                        <div class="prestamos-card-header">
                            <div class="prestamos-card-id">#@item.IdPrestamo</div>
                            <div class="prestamos-card-status @(item.Estado.ToLower())">
                                @item.Estado
                            </div>
                        </div>
                        
                        <div class="prestamos-card-body">
                            <h3 class="prestamos-card-title">@item.NumeroPrestamo</h3>
                            <p class="prestamos-card-usuario">Usuario: @item.Usuario</p>
                            
                            <div class="prestamos-card-details">
                                <div class="prestamos-detail-item">
                                    <span class="prestamos-detail-label">Nombre Completo:</span>
                                    <span class="prestamos-detail-value">@item.NombreCompleto</span>
                                </div>
                                
                                <div class="prestamos-detail-item">
                                    <span class="prestamos-detail-label">Motivo:</span>
                                    <span class="prestamos-detail-value">@(item.MotivoPrestamo ?? "N/A")</span>
                                </div>
                                
                                <div class="prestamos-detail-item">
                                    <span class="prestamos-detail-label">Fecha Creación:</span>
                                    <span class="prestamos-detail-value">@item.FechadeCreacion.ToString("dd/MM/yyyy")</span>
                                </div>
                            </div>
                            
                            <div class="prestamos-card-fechas">
                                <div class="fechas-info">
                                    <div class="fecha-item">
                                        <span class="fecha-label">Devolución:</span>
                                        <span class="fecha-value fecha-devolucion">@(item.FechaDevolucion?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                                    </div>
                                    <div class="fecha-item">
                                        <span class="fecha-label">Vencimiento:</span>
                                        <span class="fecha-value fecha-vencimiento">@(item.FechaVencimiento?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                                    </div>
                                    <div class="fecha-item">
                                        <span class="fecha-label">Días Retraso:</span>
                                        <span class="fecha-value fecha-retraso">@item.DiasRetraso días</span>
                                    </div>
                                </div>
                                
                                <div class="prestamos-alert">
                                    @if (item.Devolucion)
                                    {
                                        <span class="badge badge-success">
                                            <i class="fas fa-check"></i>
                                            Devuelto
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-warning">
                                            <i class="fas fa-clock"></i>
                                            Pendiente
                                        </span>
                                    }
                                    
                                    @if (item.EsUrgente)
                                    {
                                        <span class="badge badge-danger">
                                            <i class="fas fa-exclamation"></i>
                                            Urgente
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="prestamos-empty">
                    <i class="fas fa-hand-holding"></i>
                    <h3>No hay datos de préstamos</h3>
                    <p>Aplica filtros diferentes o verifica la configuración</p>
                </div>
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Búsqueda con debounce
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    aplicarFiltros();
                }, 500);
            });
        });

        function aplicarFiltros() {
            // Obtener valores de los filtros
            const usuarios = $('#usuarios').val();
            const estados = $('#estados').val();
            const devueltos = $('#devueltos').val();
            const fechaInicio = $('#fechaInicio').val();
            const fechaFin = $('#fechaFin').val();
            const sortBy = $('#sortBy').val();
            const sortOrder = $('#sortOrder').val();
            const pageSize = $('#pageSize').val();
            const searchTerm = $('#searchInput').val();

            // Construir URL con parámetros
            let url = '@Url.Action("Prestamos", "Reportes")';
            let params = [];

            if (usuarios) params.push('usuarios=' + usuarios);
            if (estados) params.push('estados=' + estados);
            if (devueltos) params.push('devueltos=' + devueltos);
            if (fechaInicio) params.push('fechaInicio=' + fechaInicio);
            if (fechaFin) params.push('fechaFin=' + fechaFin);
            if (sortBy) params.push('sortBy=' + sortBy);
            if (sortOrder) params.push('sortOrder=' + sortOrder);
            if (pageSize) params.push('pageSize=' + pageSize);
            if (searchTerm) params.push('search=' + encodeURIComponent(searchTerm));

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            // Redirigir con los filtros aplicados
            window.location.href = url;
        }

        function limpiarFiltros() {
            // Limpiar todos los campos
            $('#usuarios, #estados, #devueltos, #sortBy, #sortOrder, #pageSize').val('');
            $('#fechaInicio, #fechaFin').val('');
            $('#searchInput').val('');
            
            // Redirigir sin filtros
            window.location.href = '@Url.Action("Prestamos", "Reportes")';
        }

        function changePage(page) {
            // Obtener valores de los filtros actuales
            const usuarios = $('#usuarios').val();
            const estados = $('#estados').val();
            const devueltos = $('#devueltos').val();
            const fechaInicio = $('#fechaInicio').val();
            const fechaFin = $('#fechaFin').val();
            const sortBy = $('#sortBy').val();
            const sortOrder = $('#sortOrder').val();
            const pageSize = $('#pageSize').val();
            const searchTerm = $('#searchInput').val();

            // Construir URL con parámetros
            let url = '@Url.Action("Prestamos", "Reportes")';
            let params = [];

            if (usuarios) params.push('usuarios=' + usuarios);
            if (estados) params.push('estados=' + estados);
            if (devueltos) params.push('devueltos=' + devueltos);
            if (fechaInicio) params.push('fechaInicio=' + fechaInicio);
            if (fechaFin) params.push('fechaFin=' + fechaFin);
            if (sortBy) params.push('sortBy=' + sortBy);
            if (sortOrder) params.push('sortOrder=' + sortOrder);
            if (pageSize) params.push('pageSize=' + pageSize);
            if (searchTerm) params.push('search=' + encodeURIComponent(searchTerm));
            
            // Agregar página
            params.push('page=' + page);

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            // Redirigir con los filtros aplicados
            window.location.href = url;
        }
    </script>
}