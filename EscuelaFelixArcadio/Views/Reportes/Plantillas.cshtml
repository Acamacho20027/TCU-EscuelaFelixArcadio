@model List<EscuelaFelixArcadio.Models.PlantillaReporte>

@{
    ViewBag.Title = "Plantillas de Reportes";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/reportes.css" rel="stylesheet" />
}

<div class="reportes-container">
    <!-- Header -->
    <div class="reportes-header">
        <h1>
            <i class="fas fa-file-alt header-icon"></i>
            @ViewBag.Title
        </h1>
        <div class="header-subtitle">
            Utiliza plantillas predefinidas para generar reportes periódicos de forma rápida y consistente
        </div>
    </div>

    <!-- Botón para crear nueva plantilla (Solo Admin) -->
    @if (User.IsInRole("Administrador"))
    {
        <div class="form-section">
            <div class="datos-header">
                <h3>
                    <i class="fas fa-plus"></i>
                    Gestión de Plantillas
                </h3>
                <a href="@Url.Action("CrearPlantilla")" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    Crear Plantilla
                </a>
            </div>
        </div>
    }

    <!-- Grid de plantillas -->
    <div class="dashboard-grid">
        @if (Model != null && Model.Any())
        {
            foreach (var plantilla in Model)
            {
                <div class="dashboard-card">
                    <h3>
                        <i class="fas fa-file-alt card-icon"></i>
                        @plantilla.Nombre
                    </h3>
                    <div class="card-description">
                        @plantilla.Descripcion
                    </div>
                    <div class="mt-3 mb-3">
                        <span class="badge badge-info">@plantilla.TipoReporte</span>
                        @if (!plantilla.EsEditable)
                        {
                            <span class="badge badge-warning">
                                <i class="fas fa-lock"></i>
                                Solo Lectura
                            </span>
                        }
                    </div>
                    <div class="d-flex gap-2">
                        <a href="@Url.Action("GenerarPorPlantilla", new { idPlantilla = plantilla.IdPlantilla })" class="card-action">
                            <i class="fas fa-play"></i>
                            Generar Reporte
                        </a>
                        @if (User.IsInRole("Administrador") && plantilla.EsEditable)
                        {
                            <a href="@Url.Action("CrearPlantilla", new { id = plantilla.IdPlantilla })" class="card-action" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                                <i class="fas fa-edit"></i>
                                Editar
                            </a>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="dashboard-card" style="grid-column: 1 / -1; text-align: center;">
                <h3>
                    <i class="fas fa-file-alt card-icon"></i>
                    No hay plantillas disponibles
                </h3>
                <div class="card-description">
                    No se han creado plantillas de reportes aún. 
                    @if (User.IsInRole("Administrador"))
                    {
                        <span>Crea la primera plantilla para comenzar.</span>
                    }
                    else
                    {
                        <span>Contacta al administrador para crear plantillas.</span>
                    }
                </div>
                @if (User.IsInRole("Administrador"))
                {
                    <a href="@Url.Action("CrearPlantilla")" class="card-action">
                        <i class="fas fa-plus"></i>
                        Crear Primera Plantilla
                    </a>
                }
            </div>
        }
    </div>

    <!-- Plantillas predefinidas sugeridas -->
    <div class="form-section">
        <div class="filtros-header">
            <i class="fas fa-lightbulb filtros-icon"></i>
            <h3>Plantillas Sugeridas</h3>
        </div>
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-boxes card-icon"></i>
                    Inventario Mensual
                </h3>
                <div class="card-description">
                    Reporte completo del inventario con análisis de stock bajo, movimientos y alertas.
                </div>
                <div class="mt-3 mb-3">
                    <span class="badge badge-info">inventario</span>
                    <span class="badge badge-success">Mensual</span>
                </div>
                <button type="button" class="card-action" onclick="crearPlantillaSugerida('inventario-mensual')">
                    <i class="fas fa-magic"></i>
                    Crear Plantilla
                </button>
            </div>

            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-hand-holding card-icon"></i>
                    Préstamos por Período
                </h3>
                <div class="card-description">
                    Análisis de préstamos activos, devoluciones y patrones de uso del material deportivo.
                </div>
                <div class="mt-3 mb-3">
                    <span class="badge badge-info">prestamos</span>
                    <span class="badge badge-success">Período</span>
                </div>
                <button type="button" class="card-action" onclick="crearPlantillaSugerida('prestamos-periodo')">
                    <i class="fas fa-magic"></i>
                    Crear Plantilla
                </button>
            </div>

            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-exclamation-triangle card-icon"></i>
                    Sanciones Activas
                </h3>
                <div class="card-description">
                    Reporte de sanciones activas con análisis de montos, tipos y usuarios sancionados.
                </div>
                <div class="mt-3 mb-3">
                    <span class="badge badge-info">sanciones</span>
                    <span class="badge badge-warning">Activas</span>
                </div>
                <button type="button" class="card-action" onclick="crearPlantillaSugerida('sanciones-activas')">
                    <i class="fas fa-magic"></i>
                    Crear Plantilla
                </button>
            </div>

            <div class="dashboard-card">
                <h3>
                    <i class="fas fa-chart-line card-icon"></i>
                    Resumen Ejecutivo
                </h3>
                <div class="card-description">
                    Resumen general con métricas clave de inventario, préstamos y sanciones.
                </div>
                <div class="mt-3 mb-3">
                    <span class="badge badge-info">general</span>
                    <span class="badge badge-primary">Ejecutivo</span>
                </div>
                <button type="button" class="card-action" onclick="crearPlantillaSugerida('resumen-ejecutivo')">
                    <i class="fas fa-magic"></i>
                    Crear Plantilla
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Inicializar tooltips si es necesario
            $('[data-toggle="tooltip"]').tooltip();
        });

        function crearPlantillaSugerida(tipo) {
            if (!@User.IsInRole("Administrador").ToString().ToLower()) {
                alert('Solo los administradores pueden crear plantillas');
                return;
            }

            var configuraciones = {
                'inventario-mensual': {
                    nombre: 'Inventario Mensual',
                    descripcion: 'Reporte completo del inventario con análisis de stock bajo, movimientos y alertas.',
                    tipoReporte: 'inventario',
                    configuracionJSON: JSON.stringify({
                        filtros: ['stockBajo', 'categorias', 'estados'],
                        columnas: ['IdInventario', 'Producto', 'Codigo', 'Categoria', 'Estado', 'Cantidad', 'Minimo', 'Maximo', 'AlertaStockBajo'],
                        agrupacion: 'Categoria',
                        ordenamiento: 'Producto'
                    })
                },
                'prestamos-periodo': {
                    nombre: 'Préstamos por Período',
                    descripcion: 'Análisis de préstamos activos, devoluciones y patrones de uso del material deportivo.',
                    tipoReporte: 'prestamos',
                    configuracionJSON: JSON.stringify({
                        filtros: ['fechaInicio', 'fechaFin', 'usuarios', 'estados', 'devueltos'],
                        columnas: ['IdPrestamo', 'NumeroPrestamo', 'Usuario', 'Estado', 'FechadeCreacion', 'FechaDevolucion', 'DiasRetraso'],
                        agrupacion: 'Usuario',
                        ordenamiento: 'FechadeCreacion'
                    })
                },
                'sanciones-activas': {
                    nombre: 'Sanciones Activas',
                    descripcion: 'Reporte de sanciones activas con análisis de montos, tipos y usuarios sancionados.',
                    tipoReporte: 'sanciones',
                    configuracionJSON: JSON.stringify({
                        filtros: ['fechaInicio', 'fechaFin', 'usuarios', 'tipos'],
                        columnas: ['IdSancion', 'Usuario', 'Tipo', 'Motivo', 'Monto', 'FechaInicio', 'SancionActiva'],
                        agrupacion: 'Tipo',
                        ordenamiento: 'Monto'
                    })
                },
                'resumen-ejecutivo': {
                    nombre: 'Resumen Ejecutivo',
                    descripcion: 'Resumen general con métricas clave de inventario, préstamos y sanciones.',
                    tipoReporte: 'general',
                    configuracionJSON: JSON.stringify({
                        filtros: ['fechaInicio', 'fechaFin'],
                        metricas: ['totalPrestamos', 'prestamosActivos', 'totalSanciones', 'alertasCriticas', 'productosStockBajo'],
                        graficos: ['barras', 'pie', 'lineas']
                    })
                }
            };

            var config = configuraciones[tipo];
            if (config) {
                // Redirigir a crear plantilla con datos predefinidos
                var url = '@Url.Action("CrearPlantilla")' + 
                    '?nombre=' + encodeURIComponent(config.nombre) +
                    '&descripcion=' + encodeURIComponent(config.descripcion) +
                    '&tipoReporte=' + encodeURIComponent(config.tipoReporte) +
                    '&configuracionJSON=' + encodeURIComponent(config.configuracionJSON);
                
                window.location.href = url;
            }
        }
    </script>
}