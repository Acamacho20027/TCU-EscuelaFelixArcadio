@{
    ViewBag.Title = "Gráficos Interactivos";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/reportes.css" rel="stylesheet" />
}

<div class="reportes-container">
    <!-- Header -->
    <div class="reportes-header">
        <h1>
            <i class="fas fa-chart-area header-icon"></i>
            @ViewBag.Title
        </h1>
        <div class="header-subtitle">
            Visualiza datos con gráficos multidimensionales, heatmaps y análisis de actividad de usuarios
        </div>
    </div>

    <!-- Filtros para gráficos -->
    <div class="filtros-section">
        <div class="filtros-header">
            <i class="fas fa-filter filtros-icon"></i>
            <h3>Configurar Análisis</h3>
        </div>
        
        <div class="filtros-grid">
            <div class="filtro-group">
                <label for="fechaInicio">Fecha Inicio</label>
                <input type="date" id="fechaInicio" name="fechaInicio" />
            </div>
            
            <div class="filtro-group">
                <label for="fechaFin">Fecha Fin</label>
                <input type="date" id="fechaFin" name="fechaFin" />
            </div>
            
            <div class="filtro-group">
                <label for="tipoGrafico">Tipo de Gráfico</label>
                <select id="tipoGrafico">
                    <option value="actividad-usuarios">Actividad de Usuarios</option>
                    <option value="heatmap">Heatmap de Actividad</option>
                    <option value="tendencias">Tendencias Temporales</option>
                    <option value="distribucion">Distribución por Categorías</option>
                </select>
            </div>
            
            <div class="filtro-group">
                <label for="metrica">Métrica Principal</label>
                <select id="metrica">
                    <option value="prestamos">Préstamos</option>
                    <option value="sanciones">Sanciones</option>
                    <option value="documentos">Documentos</option>
                    <option value="actividad">Actividad General</option>
                </select>
            </div>
        </div>
        
        <div class="filtros-actions">
            <button type="button" class="btn-filtrar" onclick="generarGrafico()">
                <i class="fas fa-chart-line"></i>
                Generar Gráfico
            </button>
            <button type="button" class="btn-limpiar" onclick="limpiarFiltros()">
                <i class="fas fa-eraser"></i>
                Limpiar
            </button>
        </div>
    </div>

    <!-- Gráfico principal -->
    <div class="graficos-container">
        <div class="grafico-header">
            <h3>
                <i class="fas fa-chart-bar"></i>
                <span id="tituloGrafico">Gráfico de Actividad de Usuarios</span>
            </h3>
            <div class="datos-actions">
                <button type="button" class="btn-exportar" onclick="exportarGrafico()">
                    <i class="fas fa-download"></i>
                    Exportar Imagen
                </button>
                <button type="button" class="btn-exportar btn-excel" onclick="exportarDatos()">
                    <i class="fas fa-file-excel"></i>
                    Exportar Datos
                </button>
            </div>
        </div>
        
        <div class="grafico-canvas" id="graficoCanvas">
            <div class="loading">Selecciona un tipo de gráfico y genera el análisis</div>
        </div>
    </div>

    <!-- Gráficos adicionales -->
    <div class="dashboard-grid">
        <div class="graficos-container">
            <div class="grafico-header">
                <h3>
                    <i class="fas fa-chart-pie"></i>
                    Distribución por Usuario
                </h3>
            </div>
            <div class="grafico-canvas" id="graficoPie" style="height: 300px;">
                <div class="loading">Cargando datos...</div>
            </div>
        </div>

        <div class="graficos-container">
            <div class="grafico-header">
                <h3>
                    <i class="fas fa-chart-line"></i>
                    Tendencias Temporales
                </h3>
            </div>
            <div class="grafico-canvas" id="graficoLineas" style="height: 300px;">
                <div class="loading">Cargando datos...</div>
            </div>
        </div>
    </div>

    <!-- Estadísticas detalladas -->
    <div class="estadisticas-grid" id="estadisticasDetalladas">
        <!-- Se cargarán dinámicamente -->
    </div>

    <!-- Tabla de datos -->
    <div class="datos-section" id="tablaDatos" style="display: none;">
        <div class="datos-header">
            <h3>
                <i class="fas fa-table"></i>
                Datos Detallados
            </h3>
        </div>
        
        <div class="tabla-responsive">
            <table class="tabla-datos" id="tablaGrafico">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Préstamos</th>
                        <th>Sanciones</th>
                        <th>Documentos</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartInstance = null;
        let pieChartInstance = null;
        let lineChartInstance = null;

        $(document).ready(function() {
            // Establecer fechas por defecto (últimos 30 días)
            var hoy = new Date();
            var hace30Dias = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            $('#fechaInicio').val(formatearFecha(hace30Dias));
            $('#fechaFin').val(formatearFecha(hoy));
            
            // Generar gráfico inicial
            generarGrafico();
        });

        function generarGrafico() {
            var fechaInicio = $('#fechaInicio').val();
            var fechaFin = $('#fechaFin').val();
            var tipoGrafico = $('#tipoGrafico').val();
            var metrica = $('#metrica').val();
            
            if (!fechaInicio || !fechaFin) {
                alert('Por favor selecciona las fechas');
                return;
            }
            
            $('#graficoCanvas').html('<div class="loading">Generando gráfico...</div>');
            
            // Actualizar título
            var titulos = {
                'actividad-usuarios': 'Gráfico de Actividad de Usuarios',
                'heatmap': 'Heatmap de Actividad',
                'tendencias': 'Tendencias Temporales',
                'distribucion': 'Distribución por Categorías'
            };
            $('#tituloGrafico').text(titulos[tipoGrafico]);
            
            // Cargar datos según el tipo de gráfico
            switch (tipoGrafico) {
                case 'actividad-usuarios':
                    cargarDatosActividadUsuarios(fechaInicio, fechaFin);
                    break;
                case 'heatmap':
                    cargarDatosHeatmap(fechaInicio, fechaFin);
                    break;
                case 'tendencias':
                    cargarDatosTendencias(fechaInicio, fechaFin);
                    break;
                case 'distribucion':
                    cargarDatosDistribucion(fechaInicio, fechaFin);
                    break;
            }
        }

        function cargarDatosActividadUsuarios(fechaInicio, fechaFin) {
            $.get('@Url.Action("DatosGraficoActividad")', {
                fechaInicio: fechaInicio,
                fechaFin: fechaFin
            }, function(response) {
                if (response.success) {
                    mostrarGraficoActividadUsuarios(response.data);
                    mostrarTablaDatos(response.data);
                } else {
                    $('#graficoCanvas').html('<div class="text-center p-4"><i class="fas fa-exclamation-triangle text-warning"></i><br>Error al cargar datos</div>');
                }
            });
        }

        function cargarDatosHeatmap(fechaInicio, fechaFin) {
            $.get('@Url.Action("DatosHeatmap")', {
                fechaInicio: fechaInicio,
                fechaFin: fechaFin
            }, function(response) {
                if (response.success) {
                    mostrarHeatmap(response.data);
                } else {
                    $('#graficoCanvas').html('<div class="text-center p-4"><i class="fas fa-exclamation-triangle text-warning"></i><br>Error al cargar datos</div>');
                }
            });
        }

        function mostrarGraficoActividadUsuarios(datos) {
            var ctx = document.createElement('canvas');
            ctx.width = 400;
            ctx.height = 400;
            $('#graficoCanvas').html(ctx);
            
            var labels = datos.map(d => d.Usuario);
            var prestamos = datos.map(d => d.TotalPrestamos);
            var sanciones = datos.map(d => d.TotalSanciones);
            var documentos = datos.map(d => d.DocumentosSubidos);
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Usuarios',
                        data: datos.map(d => ({
                            x: d.TotalPrestamos,
                            y: d.TotalSanciones,
                            r: Math.max(5, Math.min(20, d.DocumentosSubidos * 2))
                        })),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Total Préstamos'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Sanciones'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var data = datos[context.dataIndex];
                                    return [
                                        'Usuario: ' + data.Usuario,
                                        'Préstamos: ' + data.TotalPrestamos,
                                        'Sanciones: ' + data.TotalSanciones,
                                        'Documentos: ' + data.DocumentosSubidos,
                                        'Score: ' + data.Score
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function mostrarHeatmap(datos) {
            var html = '<div class="heatmap-container">';
            html += '<div class="heatmap-header">';
            html += '<div class="heatmap-legend">';
            html += '<span>Baja</span>';
            html += '<div class="heatmap-gradient"></div>';
            html += '<span>Alta</span>';
            html += '</div>';
            html += '</div>';
            html += '<div class="heatmap-grid">';
            
            // Crear grid de días y horas
            for (var hora = 0; hora < 24; hora++) {
                html += '<div class="heatmap-row">';
                html += '<div class="heatmap-hour">' + String(hora).padStart(2, '0') + ':00</div>';
                
                for (var dia = 0; dia < 7; dia++) {
                    var valor = datos.find(d => d.Hora === hora && d.Dia === dia)?.Cantidad || 0;
                    var intensidad = Math.min(1, valor / 10); // Normalizar a 0-1
                    var color = 'rgba(102, 126, 234, ' + intensidad + ')';
                    
                    html += '<div class="heatmap-cell" style="background-color: ' + color + '" title="Día ' + dia + ', Hora ' + hora + ': ' + valor + ' actividades">';
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            html += '</div>';
            
            $('#graficoCanvas').html(html);
        }

        function mostrarTablaDatos(datos) {
            var tbody = $('#tablaGrafico tbody');
            tbody.empty();
            
            datos.forEach(function(item) {
                var row = '<tr>';
                row += '<td>' + item.Usuario + '</td>';
                row += '<td>' + item.TotalPrestamos + '</td>';
                row += '<td>' + item.TotalSanciones + '</td>';
                row += '<td>' + item.DocumentosSubidos + '</td>';
                row += '<td>' + item.Score + '</td>';
                row += '</tr>';
                tbody.append(row);
            });
            
            $('#tablaDatos').show();
        }

        function exportarGrafico() {
            if (chartInstance) {
                var url = chartInstance.toBase64Image();
                var link = document.createElement('a');
                link.download = 'grafico-actividad.png';
                link.href = url;
                link.click();
            } else {
                alert('No hay gráfico para exportar');
            }
        }

        function exportarDatos() {
            var fechaInicio = $('#fechaInicio').val();
            var fechaFin = $('#fechaFin').val();
            
            window.open('@Url.Action("DatosGraficoActividad")' + '?fechaInicio=' + fechaInicio + '&fechaFin=' + fechaFin + '&formato=excel');
        }

        function limpiarFiltros() {
            $('#fechaInicio, #fechaFin').val('');
            $('#tipoGrafico').val('actividad-usuarios');
            $('#metrica').val('prestamos');
            
            // Establecer fechas por defecto
            var hoy = new Date();
            var hace30Dias = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            $('#fechaInicio').val(formatearFecha(hace30Dias));
            $('#fechaFin').val(formatearFecha(hoy));
            
            $('#graficoCanvas').html('<div class="loading">Selecciona un tipo de gráfico y genera el análisis</div>');
            $('#tablaDatos').hide();
        }

        function formatearFecha(fecha) {
            return fecha.getFullYear() + '-' + 
                   String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(fecha.getDate()).padStart(2, '0');
        }
    </script>
    
    <style>
        .heatmap-container {
            width: 100%;
            height: 100%;
        }
        
        .heatmap-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .heatmap-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.1), rgba(102, 126, 234, 1));
            border-radius: 10px;
        }
        
        .heatmap-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .heatmap-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .heatmap-hour {
            width: 60px;
            font-size: 0.8rem;
            color: #6c757d;
            text-align: right;
        }
        
        .heatmap-cell {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.1);
            border: 2px solid #667eea;
        }
    </style>
}