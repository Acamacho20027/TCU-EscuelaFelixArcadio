@{
    ViewBag.Title = "Ver Reporte";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/reportes.css" rel="stylesheet" />
    <link href="~/Content/ver-reporte.css" rel="stylesheet" />
}

<div class="reportes-container">
    <!-- Header -->
    <div class="ver-reporte-header">
        <a href="@Url.Action("Index", "Reportes")" class="btn-volver-reportes">
            <i class="fas fa-arrow-left"></i> Volver a Reportes
        </a>
        <h1 class="ver-reporte-title">@ViewBag.Title</h1>
        <div class="ver-reporte-spacer"></div>
    </div>

    <!-- Comentarios y anotaciones -->
    <div class="comentarios-section">
        <div class="filtros-header">
            <i class="fas fa-comments filtros-icon"></i>
            <h3>Comentarios y Anotaciones</h3>
        </div>
        
        <!-- Formulario para agregar comentario -->
        <div class="form-section">
            <form id="formComentario">
                @Html.AntiForgeryToken()
                <div class="filtros-grid">
                    <div class="filtro-group">
                        <label for="Comentario">Nuevo Comentario</label>
                        <textarea id="Comentario" name="Comentario" rows="3" placeholder="Escribe tu comentario aquí..."></textarea>
                    </div>
                    
                    <div class="filtro-group">
                        <label for="EsAnotacion">Tipo</label>
                        <select id="EsAnotacion" name="EsAnotacion">
                            <option value="false">Comentario General</option>
                            <option value="true">Anotación Específica</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary btn-agregar-comentario">
                        <i class="fas fa-plus"></i>
                        Agregar Comentario
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Lista de comentarios -->
        <div id="listaComentarios">
            @if (ViewBag.Comentarios != null && ((List<EscuelaFelixArcadio.Models.ComentarioReporte>)ViewBag.Comentarios).Any())
            {
                foreach (var comentario in (List<EscuelaFelixArcadio.Models.ComentarioReporte>)ViewBag.Comentarios)
                {
                    <div class="comentario-item">
                        <div class="comentario-avatar">
                            @(comentario.IdUsuario?.Substring(0, 1).ToUpper() ?? "U")
                        </div>
                        <div class="comentario-content">
                            <div class="comentario-texto">@comentario.Comentario</div>
                            @if (comentario.EsAnotacion)
                            {
                                <div class="comentario-anotacion">
                                    <i class="fas fa-map-pin"></i>
                                    Anotación específica
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center p-4">
                    <i class="fas fa-comments" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                    <p style="color: #6c757d;">No hay comentarios aún</p>
                </div>
            }
        </div>
    </div>

    <!-- Datos del reporte -->
    <div class="datos-section">
        <div class="datos-header">
            <h3>
                <i class="fas fa-table"></i>
                Datos del Reporte
            </h3>
            <div class="datos-actions">
                <button type="button" class="btn-exportar" onclick="descargarReporte()">
                    <i class="fas fa-download"></i>
                    Descargar
                </button>
            </div>
        </div>
        
        <!-- Cards Grid -->
        <div class="inventario-cards-grid">
            @if (ViewBag.Datos != null && ((IEnumerable<dynamic>)ViewBag.Datos).Any())
            {
                var datos = (IEnumerable<dynamic>)ViewBag.Datos;
                foreach (var item in datos)
                {
                    <div class="inventario-card">
                        <div class="inventario-card-header">
                            <div class="inventario-card-title">
                                @{
                                    var propiedades = item.GetType().GetProperties();
                                    var primeraPropiedad = propiedades.Length > 0 ? propiedades[0] : null;
                                    var segundaPropiedad = propiedades.Length > 1 ? propiedades[1] : null;
                                }
                                @if (primeraPropiedad != null && segundaPropiedad != null)
                                {
                                    <span class="inventario-id">@primeraPropiedad.GetValue(item)</span>
                                    <span class="inventario-nombre">@segundaPropiedad.GetValue(item)</span>
                                }
                            </div>
                        </div>
                        
                        <div class="inventario-card-body">
                            <div class="inventario-details">
                                @for (int i = 2; i < propiedades.Length; i++)
                                {
                                    var propiedad = propiedades[i];
                                    <div class="inventario-detail-item">
                                        <span class="inventario-detail-label">@propiedad.Name:</span>
                                        <span class="inventario-detail-value">@propiedad.GetValue(item)</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h4>No hay datos disponibles</h4>
                    <p>No se encontraron registros para mostrar.</p>
                </div>
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Configurar formulario de comentarios
            $('#formComentario').on('submit', function(e) {
                e.preventDefault();
                agregarComentario();
            });
        });

        function agregarComentario() {
            var comentario = $('#Comentario').val();
            var esAnotacion = $('#EsAnotacion').val() === 'true';
            
            if (!comentario || comentario.trim() === '') {
                alert('Por favor escribe un comentario');
                return;
            }
            
            console.log('Enviando comentario:', {
                IdReporteGuardado: @(ViewBag.ReporteId ?? 0),
                Comentario: comentario,
                EsAnotacion: esAnotacion
            });
            
            $.ajax({
                url: '@Url.Action("AgregarComentario")',
                type: 'POST',
                data: {
                    IdReporteGuardado: @(ViewBag.ReporteId ?? 0),
                    Comentario: comentario,
                    EsAnotacion: esAnotacion,
                    IdUsuario: '',
                    FechaCreacion: '',
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    console.log('Respuesta del servidor:', response);
                    if (response.success) {
                        mostrarModalExito();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error AJAX:', xhr.responseText);
                    console.log('Status:', status);
                    console.log('Error:', error);
                    alert('Error al agregar el comentario: ' + error);
                }
            });
        }

        function descargarReporte() {
            var url = '@Url.Action("ExportarPDF", new { tipoReporte = ViewBag.Reporte?.TipoReporte ?? "reporte", filtros = ViewBag.Reporte?.FiltrosUtilizados ?? "" })';
            
            // Crear un elemento temporal para forzar la descarga
            var link = document.createElement('a');
            link.href = url;
            link.download = 'reporte.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function compartirReporte() {
            var url = window.location.href;
            var enlaceCompartir = prompt('Enlace para compartir:', url);
            
            if (enlaceCompartir) {
                navigator.clipboard.writeText(enlaceCompartir).then(function() {
                    alert('Enlace copiado al portapapeles');
                });
            }
        }

        function editarReporte() {
            var tipoReporte = '@ViewBag.Reporte?.TipoReporte';
            var filtros = '@ViewBag.Reporte?.FiltrosUtilizados';
            
            // Redirigir a la página de configuración con los datos actuales
            var url = '@Url.Action("ConfiguracionPersonalizada")' + 
                '?tipoReporte=' + encodeURIComponent(tipoReporte) +
                '&filtros=' + encodeURIComponent(filtros);
            
            window.location.href = url;
        }

        function duplicarReporte() {
            var nombreNuevo = prompt('Nombre para el reporte duplicado:');
            if (nombreNuevo && nombreNuevo.trim() !== '') {
                // Aquí se implementaría la lógica para duplicar el reporte
                alert('Reporte duplicado como: ' + nombreNuevo);
            }
        }

        function programarGeneracion() {
            var frecuencia = prompt('Frecuencia de generación (diario, semanal, mensual):');
            if (frecuencia && ['diario', 'semanal', 'mensual'].includes(frecuencia.toLowerCase())) {
                alert('Generación programada: ' + frecuencia);
            } else {
                alert('Frecuencia no válida');
            }
        }

        function crearGrafico() {
            var tipoGrafico = prompt('Tipo de gráfico (barras, lineas, pie, scatter):');
            if (tipoGrafico && ['barras', 'lineas', 'pie', 'scatter'].includes(tipoGrafico.toLowerCase())) {
                // Redirigir a gráficos con datos predefinidos
                var url = '@Url.Action("GraficosInteractivos")' + 
                    '?tipoGrafico=' + encodeURIComponent(tipoGrafico) +
                    '&datosReporte=' + encodeURIComponent('@ViewBag.Reporte?.IdReporteGuardado');
                
                window.location.href = url;
            } else {
                alert('Tipo de gráfico no válido');
            }
        }

        function mostrarModalExito() {
            // Crear modal si no existe
            if ($('#modalExito').length === 0) {
                $('body').append(`
                    <div id="modalExito" class="modal-exito-overlay" style="display: flex;">
                        <div class="modal-exito-content">
                            <div class="modal-exito-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="modal-exito-title">¡Comentario Agregado!</div>
                            <div class="modal-exito-message">El comentario se ha agregado exitosamente al reporte.</div>
                            <div class="modal-exito-actions">
                                <button class="btn-modal-exito" onclick="cerrarModalExito()">Aceptar</button>
                            </div>
                        </div>
                    </div>
                `);
            } else {
                $('#modalExito').show();
            }
            
            // Auto-cerrar después de 3 segundos
            setTimeout(function() {
                cerrarModalExito();
            }, 3000);
        }

        function cerrarModalExito() {
            $('#modalExito').fadeOut(300, function() {
                location.reload();
            });
        }
    </script>
}