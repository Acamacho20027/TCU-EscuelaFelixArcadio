@{
    ViewBag.Title = "Ver Reporte";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/reportes.css" rel="stylesheet" />
}

<div class="reportes-container">
    <!-- Header -->
    <div class="reportes-header">
        <h1>
            <i class="fas fa-eye header-icon"></i>
            @ViewBag.Title
        </h1>
        <div class="header-subtitle">
            Visualización detallada del reporte generado
        </div>
    </div>

    <!-- Información del reporte -->
    @if (ViewBag.Reporte != null)
    {
        <div class="form-section">
            <div class="filtros-header">
                <i class="fas fa-info-circle filtros-icon"></i>
                <h3>Información del Reporte</h3>
            </div>
            
            <div class="filtros-grid">
                <div class="filtro-group">
                    <label>Nombre del Reporte</label>
                    <input type="text" value="@ViewBag.Reporte.NombreReporte" readonly />
                </div>
                
                <div class="filtro-group">
                    <label>Tipo de Reporte</label>
                    <input type="text" value="@ViewBag.Reporte.TipoReporte" readonly />
                </div>
                
                <div class="filtro-group">
                    <label>Formato</label>
                    <input type="text" value="@ViewBag.Reporte.Formato" readonly />
                </div>
                
                <div class="filtro-group">
                    <label>Fecha de Generación</label>
                    <input type="text" value="@ViewBag.Reporte.FechaGeneracion.ToString("dd/MM/yyyy HH:mm")" readonly />
                </div>
                
                <div class="filtro-group">
                    <label>Generado por</label>
                    <input type="text" value="@ViewBag.Reporte.GeneradoPor" readonly />
                </div>
                
                <div class="filtro-group">
                    <label>Filtros Utilizados</label>
                    <textarea readonly rows="2">@ViewBag.Reporte.FiltrosUtilizados</textarea>
                </div>
            </div>
        </div>
    }

    <!-- Comentarios y anotaciones -->
    <div class="comentarios-section">
        <div class="filtros-header">
            <i class="fas fa-comments filtros-icon"></i>
            <h3>Comentarios y Anotaciones</h3>
        </div>
        
        <!-- Formulario para agregar comentario -->
        <div class="form-section">
            <form id="formComentario">
                <div class="filtros-grid">
                    <div class="filtro-group">
                        <label for="comentario">Nuevo Comentario</label>
                        <textarea id="comentario" name="comentario" rows="3" placeholder="Escribe tu comentario aquí..."></textarea>
                    </div>
                    
                    <div class="filtro-group">
                        <label for="esAnotacion">Tipo</label>
                        <select id="esAnotacion" name="esAnotacion">
                            <option value="false">Comentario General</option>
                            <option value="true">Anotación Específica</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Agregar Comentario
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Lista de comentarios -->
        <div id="listaComentarios">
            @if (ViewBag.Comentarios != null && ((List<EscuelaFelixArcadio.Models.ComentarioReporte>)ViewBag.Comentarios).Any())
            {
                @foreach (var comentario in (List<EscuelaFelixArcadio.Models.ComentarioReporte>)ViewBag.Comentarios)
                {
                    <div class="comentario-item">
                        <div class="comentario-avatar">
                            @comentario.Usuario.Substring(0, 1).ToUpper()
                        </div>
                        <div class="comentario-content">
                            <div class="comentario-header">
                                <div class="comentario-usuario">@comentario.Usuario</div>
                                <div class="comentario-fecha">@comentario.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                            <div class="comentario-texto">@comentario.Comentario</div>
                            @if (comentario.EsAnotacion)
                            {
                                <div class="comentario-anotacion">
                                    <i class="fas fa-map-pin"></i>
                                    Anotación específica
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center p-4">
                    <i class="fas fa-comments" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                    <p style="color: #6c757d;">No hay comentarios aún</p>
                </div>
            }
        </div>
    </div>

    <!-- Datos del reporte -->
    <div class="datos-section">
        <div class="datos-header">
            <h3>
                <i class="fas fa-table"></i>
                Datos del Reporte
            </h3>
            <div class="datos-actions">
                <button type="button" class="btn-exportar" onclick="descargarReporte()">
                    <i class="fas fa-download"></i>
                    Descargar
                </button>
                <button type="button" class="btn-exportar btn-excel" onclick="compartirReporte()">
                    <i class="fas fa-share"></i>
                    Compartir
                </button>
            </div>
        </div>
        
        <div class="tabla-responsive">
            <table class="tabla-datos">
                <thead>
                    <tr>
                        @if (ViewBag.Datos != null && ((IEnumerable<dynamic>)ViewBag.Datos).Any())
                        {
                            var primerElemento = ((IEnumerable<dynamic>)ViewBag.Datos).First();
                            foreach (var propiedad in primerElemento.GetType().GetProperties())
                            {
                                <th>@propiedad.Name</th>
                            }
                        }
                        else
                        {
                            <th>No hay datos disponibles</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @if (ViewBag.Datos != null)
                    {
                        foreach (var item in (IEnumerable<dynamic>)ViewBag.Datos)
                        {
                            <tr>
                                @foreach (var propiedad in item.GetType().GetProperties())
                                {
                                    <td>@propiedad.GetValue(item)</td>
                                }
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="100%" class="text-center">
                                <div class="loading">Cargando datos del reporte...</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Acciones adicionales -->
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-edit card-icon"></i>
                Editar Reporte
            </h3>
            <div class="card-description">
                Modifica los filtros y configuración de este reporte.
            </div>
            <button type="button" class="card-action" onclick="editarReporte()">
                <i class="fas fa-edit"></i>
                Editar
            </button>
        </div>

        <div class="dashboard-card">
            <h3>
                <i class="fas fa-copy card-icon"></i>
                Duplicar Reporte
            </h3>
            <div class="card-description">
                Crea una copia de este reporte con una nueva configuración.
            </div>
            <button type="button" class="card-action" onclick="duplicarReporte()">
                <i class="fas fa-copy"></i>
                Duplicar
            </button>
        </div>

        <div class="dashboard-card">
            <h3>
                <i class="fas fa-calendar card-icon"></i>
                Programar Generación
            </h3>
            <div class="card-description">
                Programa la generación automática de este reporte.
            </div>
            <button type="button" class="card-action" onclick="programarGeneracion()">
                <i class="fas fa-calendar"></i>
                Programar
            </button>
        </div>

        <div class="dashboard-card">
            <h3>
                <i class="fas fa-chart-line card-icon"></i>
                Crear Gráfico
            </h3>
            <div class="card-description">
                Genera gráficos basados en los datos de este reporte.
            </div>
            <button type="button" class="card-action" onclick="crearGrafico()">
                <i class="fas fa-chart-line"></i>
                Crear Gráfico
            </button>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Configurar formulario de comentarios
            $('#formComentario').on('submit', function(e) {
                e.preventDefault();
                agregarComentario();
            });
        });

        function agregarComentario() {
            var comentario = $('#comentario').val();
            var esAnotacion = $('#esAnotacion').val() === 'true';
            
            if (!comentario || comentario.trim() === '') {
                alert('Por favor escribe un comentario');
                return;
            }
            
            $.ajax({
                url: '@Url.Action("AgregarComentario")',
                type: 'POST',
                data: {
                    idReporte: @(ViewBag.Reporte?.IdReporteGuardado ?? 0),
                    comentario: comentario,
                    esAnotacion: esAnotacion,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        alert('Comentario agregado exitosamente');
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('Error al agregar el comentario');
                }
            });
        }

        function descargarReporte() {
            var url = '@Url.Action("ExportarPDF", new { tipoReporte = ViewBag.Reporte?.TipoReporte ?? "reporte", filtros = ViewBag.Reporte?.FiltrosUtilizados ?? "" })';
            window.open(url, '_blank');
        }

        function compartirReporte() {
            var url = window.location.href;
            var enlaceCompartir = prompt('Enlace para compartir:', url);
            
            if (enlaceCompartir) {
                navigator.clipboard.writeText(enlaceCompartir).then(function() {
                    alert('Enlace copiado al portapapeles');
                });
            }
        }

        function editarReporte() {
            var tipoReporte = '@ViewBag.Reporte?.TipoReporte';
            var filtros = '@ViewBag.Reporte?.FiltrosUtilizados';
            
            // Redirigir a la página de configuración con los datos actuales
            var url = '@Url.Action("ConfiguracionPersonalizada")' + 
                '?tipoReporte=' + encodeURIComponent(tipoReporte) +
                '&filtros=' + encodeURIComponent(filtros);
            
            window.location.href = url;
        }

        function duplicarReporte() {
            var nombreNuevo = prompt('Nombre para el reporte duplicado:');
            if (nombreNuevo && nombreNuevo.trim() !== '') {
                // Aquí se implementaría la lógica para duplicar el reporte
                alert('Reporte duplicado como: ' + nombreNuevo);
            }
        }

        function programarGeneracion() {
            var frecuencia = prompt('Frecuencia de generación (diario, semanal, mensual):');
            if (frecuencia && ['diario', 'semanal', 'mensual'].includes(frecuencia.toLowerCase())) {
                alert('Generación programada: ' + frecuencia);
            } else {
                alert('Frecuencia no válida');
            }
        }

        function crearGrafico() {
            var tipoGrafico = prompt('Tipo de gráfico (barras, lineas, pie, scatter):');
            if (tipoGrafico && ['barras', 'lineas', 'pie', 'scatter'].includes(tipoGrafico.toLowerCase())) {
                // Redirigir a gráficos con datos predefinidos
                var url = '@Url.Action("GraficosInteractivos")' + 
                    '?tipoGrafico=' + encodeURIComponent(tipoGrafico) +
                    '&datosReporte=' + encodeURIComponent('@ViewBag.Reporte?.IdReporteGuardado');
                
                window.location.href = url;
            } else {
                alert('Tipo de gráfico no válido');
            }
        }
    </script>
}