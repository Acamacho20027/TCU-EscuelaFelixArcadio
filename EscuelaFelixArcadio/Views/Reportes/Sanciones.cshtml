@model List<EscuelaFelixArcadio.Models.ViewModels.ReporteSancionesViewModel>

@{
    ViewBag.Title = "Reportes de Sanciones";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/reportes.css?v=3.4" rel="stylesheet" />
}

<div class="reportes-container">
    <!-- Header -->
    <div class="reportes-header" style="display: flex; align-items: center; justify-content: space-between;">
        <a href="@Url.Action("Index", "Reportes")" class="btn-reservas-cancel">
            <i class="fas fa-arrow-left"></i> Volver a Reportes
        </a>
        <h1 class="reportes-title" style="margin: 0;">@ViewBag.Title</h1>
        <div style="width: 200px;"></div>
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
        <!-- Barra de búsqueda -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar por usuario, tipo, motivo..." />
        </div>
        
        @using (Html.BeginForm("Sanciones", "Reportes", FormMethod.Get, new { @class = "filtros-form", @id = "filtrosForm" }))
        {
            <!-- Primera fila de filtros -->
            <div class="filtros-row">
                <div class="filtro-group">
                    <label for="usuarios">Usuario</label>
                    <select id="usuarios" name="usuarios" onchange="aplicarFiltros()">
                        <option value="">Todos los usuarios</option>
                        @if (ViewBag.Usuarios != null)
                        {
                            foreach (var usuario in (List<EscuelaFelixArcadio.Models.ApplicationUser>)ViewBag.Usuarios)
                            {
                                <option value="@usuario.Id" @(Request.QueryString["usuarios"] == usuario.Id ? "selected" : "")>@usuario.UserName</option>
                            }
                        }
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="tipos">Tipo de Sanción</label>
                    <select id="tipos" name="tipos" onchange="aplicarFiltros()">
                        <option value="">Todos los tipos</option>
                        <option value="Retraso" @(Request.QueryString["tipos"] == "Retraso" ? "selected" : "")>Retraso</option>
                        <option value="Daño" @(Request.QueryString["tipos"] == "Daño" ? "selected" : "")>Daño</option>
                        <option value="Pérdida" @(Request.QueryString["tipos"] == "Pérdida" ? "selected" : "")>Pérdida</option>
                        <option value="Mal Uso" @(Request.QueryString["tipos"] == "Mal Uso" ? "selected" : "")>Mal Uso</option>
                        <option value="Otro" @(Request.QueryString["tipos"] == "Otro" ? "selected" : "")>Otro</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="estados">Estado</label>
                    <select id="estados" name="estados" onchange="aplicarFiltros()">
                        <option value="">Todos los estados</option>
                        <option value="Activo" @(Request.QueryString["estados"] == "Activo" ? "selected" : "")>Activo</option>
                        <option value="Inactivo" @(Request.QueryString["estados"] == "Inactivo" ? "selected" : "")>Inactivo</option>
                    </select>
                </div>
            </div>
            
            <!-- Segunda fila de filtros -->
            <div class="filtros-row">
                <div class="filtro-group">
                    <label for="fechaInicio">Fecha Inicio</label>
                    <input type="date" id="fechaInicio" name="fechaInicio" value="@Request.QueryString["fechaInicio"]" onchange="aplicarFiltros()" />
                </div>
                
                <div class="filtro-group">
                    <label for="fechaFin">Fecha Fin</label>
                    <input type="date" id="fechaFin" name="fechaFin" value="@Request.QueryString["fechaFin"]" onchange="aplicarFiltros()" />
                </div>
                
                <div class="filtro-group">
                    <label for="sortBy">Ordenar por:</label>
                    <select id="sortBy" name="sortBy" onchange="aplicarFiltros()">
                        <option value="Usuario" @(Request.QueryString["sortBy"] == "Usuario" ? "selected" : "")>Usuario</option>
                        <option value="TipoSancion" @(Request.QueryString["sortBy"] == "TipoSancion" ? "selected" : "")>Tipo</option>
                        <option value="FechaInicio" @(Request.QueryString["sortBy"] == "FechaInicio" ? "selected" : "")>Fecha Inicio</option>
                        <option value="FechaFin" @(Request.QueryString["sortBy"] == "FechaFin" ? "selected" : "")>Fecha Fin</option>
                        <option value="Monto" @(Request.QueryString["sortBy"] == "Monto" ? "selected" : "")>Monto</option>
                        <option value="Estado" @(Request.QueryString["sortBy"] == "Estado" ? "selected" : "")>Estado</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="sortOrder">Orden:</label>
                    <select id="sortOrder" name="sortOrder" onchange="aplicarFiltros()">
                        <option value="asc" @(Request.QueryString["sortOrder"] == "asc" ? "selected" : "")>Ascendente</option>
                        <option value="desc" @(Request.QueryString["sortOrder"] == "desc" ? "selected" : "")>Descendente</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="pageSize">Mostrar:</label>
                    <select id="pageSize" name="pageSize" onchange="aplicarFiltros()">
                        <option value="10" @(Request.QueryString["pageSize"] == "10" ? "selected" : "")>10</option>
                        <option value="25" @(Request.QueryString["pageSize"] == "25" ? "selected" : "")>25</option>
                        <option value="50" @(Request.QueryString["pageSize"] == "50" ? "selected" : "")>50</option>
                        <option value="100" @(Request.QueryString["pageSize"] == "100" ? "selected" : "")>100</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <button type="button" class="btn-limpiar-filtros" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Datos del Reporte -->
    <div class="datos-section">
        <div class="datos-header">
            <h3>
                <i class="fas fa-table"></i>
                Datos de Sanciones
            </h3>
            <div class="datos-actions">
                <a href="@Url.Action("ExportarPDF", new { tipoReporte = "sanciones", filtros = Request.QueryString.ToString() })" class="btn-exportar">
                    <i class="fas fa-file-pdf"></i>
                    Exportar PDF
                </a>
                <a href="@Url.Action("ExportarExcel", new { tipoReporte = "sanciones", filtros = Request.QueryString.ToString() })" class="btn-exportar btn-excel">
                    <i class="fas fa-file-excel"></i>
                    Exportar Excel
                </a>
            </div>
        </div>
        
        <!-- Cards Grid -->
        <div class="sanciones-cards-grid">
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <div class="sanciones-card">
                        <div class="sanciones-card-header">
                            <div class="sanciones-card-id">#@item.IdSancion</div>
                            <div class="sanciones-card-status @(item.Estado.ToLower())">
                                @item.Estado
                            </div>
                        </div>
                        
                        <div class="sanciones-card-body">
                            <h3 class="sanciones-card-title">@item.Usuario</h3>
                            <p class="sanciones-card-nombre">@item.NombreCompleto</p>
                            
                            <div class="sanciones-card-details">
                                <div class="sanciones-detail-item">
                                    <span class="sanciones-detail-label">Tipo:</span>
                                    <span class="sanciones-detail-value">
                                        <span class="badge badge-info">@item.Tipo</span>
                                    </span>
                                </div>
                                
                                <div class="sanciones-detail-item">
                                    <span class="sanciones-detail-label">Motivo:</span>
                                    <span class="sanciones-detail-value">@item.Motivo</span>
                                </div>
                                
                                <div class="sanciones-detail-item">
                                    <span class="sanciones-detail-label">Préstamo:</span>
                                    <span class="sanciones-detail-value">@item.PrestamoRelacionado</span>
                                </div>
                            </div>
                            
                            <div class="sanciones-card-info">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Monto:</span>
                                        <span class="info-value monto">₡@item.Monto.ToString("N2")</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Inicio:</span>
                                        <span class="info-value fecha-inicio">@item.FechaInicio.ToString("dd/MM/yyyy")</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Fin:</span>
                                        <span class="info-value fecha-fin">@(item.FechaFin?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                                    </div>
                                </div>
                                
                                <div class="sanciones-alert">
                                    @if (item.SancionActiva)
                                    {
                                        <span class="badge badge-danger">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Sanción Activa
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-success">
                                            <i class="fas fa-check"></i>
                                            Finalizada
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="sanciones-empty">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>No hay datos de sanciones</h3>
                    <p>Aplica filtros diferentes o verifica la configuración</p>
                </div>
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Búsqueda con debounce
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    aplicarFiltros();
                }, 500);
            });
        });

        function aplicarFiltros() {
            // Obtener valores de los filtros
            const usuarios = $('#usuarios').val();
            const tipos = $('#tipos').val();
            const estados = $('#estados').val();
            const fechaInicio = $('#fechaInicio').val();
            const fechaFin = $('#fechaFin').val();
            const sortBy = $('#sortBy').val();
            const sortOrder = $('#sortOrder').val();
            const pageSize = $('#pageSize').val();
            const searchTerm = $('#searchInput').val();

            // Construir URL con parámetros
            let url = '@Url.Action("Sanciones", "Reportes")';
            let params = [];

            if (usuarios) params.push('usuarios=' + usuarios);
            if (tipos) params.push('tipos=' + tipos);
            if (estados) params.push('estados=' + estados);
            if (fechaInicio) params.push('fechaInicio=' + fechaInicio);
            if (fechaFin) params.push('fechaFin=' + fechaFin);
            if (sortBy) params.push('sortBy=' + sortBy);
            if (sortOrder) params.push('sortOrder=' + sortOrder);
            if (pageSize) params.push('pageSize=' + pageSize);
            if (searchTerm) params.push('search=' + encodeURIComponent(searchTerm));

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            // Redirigir con los filtros aplicados
            window.location.href = url;
        }

        function limpiarFiltros() {
            // Limpiar todos los campos
            $('#usuarios, #tipos, #estados, #sortBy, #sortOrder, #pageSize').val('');
            $('#fechaInicio, #fechaFin').val('');
            $('#searchInput').val('');
            
            // Redirigir sin filtros
            window.location.href = '@Url.Action("Sanciones", "Reportes")';
        }

        function changePage(page) {
            // Obtener valores de los filtros actuales
            const usuarios = $('#usuarios').val();
            const tipos = $('#tipos').val();
            const estados = $('#estados').val();
            const fechaInicio = $('#fechaInicio').val();
            const fechaFin = $('#fechaFin').val();
            const sortBy = $('#sortBy').val();
            const sortOrder = $('#sortOrder').val();
            const pageSize = $('#pageSize').val();
            const searchTerm = $('#searchInput').val();

            // Construir URL con parámetros
            let url = '@Url.Action("Sanciones", "Reportes")';
            let params = [];

            if (usuarios) params.push('usuarios=' + usuarios);
            if (tipos) params.push('tipos=' + tipos);
            if (estados) params.push('estados=' + estados);
            if (fechaInicio) params.push('fechaInicio=' + fechaInicio);
            if (fechaFin) params.push('fechaFin=' + fechaFin);
            if (sortBy) params.push('sortBy=' + sortBy);
            if (sortOrder) params.push('sortOrder=' + sortOrder);
            if (pageSize) params.push('pageSize=' + pageSize);
            if (searchTerm) params.push('search=' + encodeURIComponent(searchTerm));
            
            // Agregar página
            params.push('page=' + page);

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            // Redirigir con los filtros aplicados
            window.location.href = url;
        }
    </script>
}