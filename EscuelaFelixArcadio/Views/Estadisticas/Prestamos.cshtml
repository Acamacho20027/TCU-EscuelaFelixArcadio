@{
    ViewBag.Title = "Análisis de Préstamos Deportivos";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/estadisticas.css?v=22.0" rel="stylesheet" />
}

<div class="estadisticas-container">
    <!-- Header Principal -->
    <div class="estadisticas-header">
        <div class="header-left">
            <a href="@Url.Action("Index")" class="btn-volver">
                <i class="fas fa-arrow-left"></i>
                Volver a Estadísticas
            </a>
        </div>
        <h1 class="estadisticas-title">@ViewBag.Title</h1>
        <div class="header-actions"></div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="estadisticas-grid">
        <div class="estadistica-card">
            <div class="estadistica-valor" id="totalPrestamos">-</div>
            <div class="estadistica-label">TOTAL PRÉSTAMOS</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="devueltos">-</div>
            <div class="estadistica-label">DEVUELTOS</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="pendientes">-</div>
            <div class="estadistica-label">PENDIENTES</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="tiempoPromedio">-</div>
            <div class="estadistica-label">TIEMPO PROMEDIO (DÍAS)</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="tasaDevolucion">-</div>
            <div class="estadistica-label">TASA DE DEVOLUCIÓN</div>
        </div>
    </div>

    <!-- Gráfico de Tendencias -->
    <div class="graficos-container">
        <div class="grafico-header">
            <h3 class="grafico-title">Tendencias de Préstamos</h3>
            <div class="grafico-controls">
                <button class="btn-exportar" onclick="exportarDatos('prestamos')">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
        </div>
        <div class="grafico-canvas" id="graficoTendencias">
            <div class="loading">Cargando gráfico de tendencias...</div>
        </div>
    </div>

    <!-- Análisis de Patrones -->
    <div class="tabla-container">
        <div class="tabla-header">
            <h3 class="tabla-title">Patrones de Uso</h3>
            <div class="tabla-actions">
                <button class="btn-exportar" onclick="exportarDatos('patrones')">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
        </div>
        <div id="tablaPatrones">
            <div class="loading">Cargando patrones de uso...</div>
        </div>
    </div>

    <!-- Predicciones -->
    <div class="graficos-container">
        <div class="grafico-header">
            <h3 class="grafico-title">Predicciones de Préstamos</h3>
            <div class="grafico-controls">
                <button class="btn-exportar" onclick="exportarDatos('predicciones')">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
        </div>
        <div class="grafico-canvas" id="graficoPredicciones">
            <div class="loading">Generando predicciones...</div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartTendencias = null;
        let chartPredicciones = null;

        $(document).ready(function() {
            // Cargar datos iniciales
            cargarEstadisticasGenerales();
            cargarTendencias();
            cargarPatrones();
            generarPredicciones();
        });

        function cargarEstadisticasGenerales() {
            // Simular datos de ejemplo para las estadísticas generales
            setTimeout(function() {
                $('#totalPrestamos').text('156');
                $('#devueltos').text('142');
                $('#pendientes').text('14');
                $('#tiempoPromedio').text('3.2');
                $('#tasaDevolucion').text('91%');
            }, 500);
        }
        
        function cargarTendencias() {
            $('#graficoTendencias').html('<div class="loading">Cargando tendencias...</div>');
            
            // Simular datos de ejemplo
            setTimeout(function() {
                const datosEjemplo = [
                    { Fecha: '2025-01-01', Cantidad: 5, Devueltos: 3 },
                    { Fecha: '2025-01-02', Cantidad: 8, Devueltos: 6 },
                    { Fecha: '2025-01-03', Cantidad: 12, Devueltos: 9 },
                    { Fecha: '2025-01-04', Cantidad: 7, Devueltos: 5 },
                    { Fecha: '2025-01-05', Cantidad: 15, Devueltos: 12 },
                    { Fecha: '2025-01-06', Cantidad: 10, Devueltos: 8 },
                    { Fecha: '2025-01-07', Cantidad: 6, Devueltos: 4 }
                ];
                crearGraficoTendencias(datosEjemplo);
            }, 1000);
        }

        function crearGraficoTendencias(datos) {
            const ctx = document.createElement('canvas');
            $('#graficoTendencias').html(ctx);
            
            if (chartTendencias) {
                chartTendencias.destroy();
            }
            
            chartTendencias = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datos.map(d => d.Fecha),
                    datasets: [{
                        label: 'Total Préstamos',
                        data: datos.map(d => d.Cantidad),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Devueltos',
                        data: datos.map(d => d.Devueltos),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendencias de Préstamos por Período'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function cargarPatrones() {
            $('#tablaPatrones').html('<div class="loading">Cargando patrones de uso...</div>');
            
            // Simular datos de ejemplo
            setTimeout(function() {
                const patronesEjemplo = {
                    PatronDiaSemana: [
                        { DiaSemana: 'Lunes', Cantidad: 8, Porcentaje: 15 },
                        { DiaSemana: 'Martes', Cantidad: 12, Porcentaje: 22 },
                        { DiaSemana: 'Miércoles', Cantidad: 15, Porcentaje: 28 },
                        { DiaSemana: 'Jueves', Cantidad: 10, Porcentaje: 18 },
                        { DiaSemana: 'Viernes', Cantidad: 9, Porcentaje: 17 }
                    ],
                    PatronMotivo: [
                        { Motivo: 'Clase de Educación Física', Cantidad: 25, Porcentaje: 45 },
                        { Motivo: 'Práctica Deportiva', Cantidad: 18, Porcentaje: 32 },
                        { Motivo: 'Competencia', Cantidad: 8, Porcentaje: 15 },
                        { Motivo: 'Recreación', Cantidad: 4, Porcentaje: 8 }
                    ]
                };
                mostrarPatrones(patronesEjemplo);
            }, 1500);
        }

        function mostrarPatrones(patrones) {
            let html = '<div class="tabla-datos-container">';
            
            // Patrón por día de la semana
            html += '<h4>Patrón por Día de la Semana</h4>';
            html += '<table class="tabla-datos"><thead><tr><th>Día</th><th>Cantidad</th><th>Porcentaje</th></tr></thead><tbody>';
            patrones.PatronDiaSemana.forEach(p => {
                html += `<tr><td>${p.DiaSemana}</td><td>${p.Cantidad}</td><td>${p.Porcentaje}%</td></tr>`;
            });
            html += '</tbody></table>';
            
            // Patrón por motivo
            html += '<h4>Patrón por Motivo de Préstamo</h4>';
            html += '<table class="tabla-datos"><thead><tr><th>Motivo</th><th>Cantidad</th><th>Porcentaje</th></tr></thead><tbody>';
            patrones.PatronMotivo.forEach(p => {
                html += `<tr><td>${p.Motivo}</td><td>${p.Cantidad}</td><td>${p.Porcentaje}%</td></tr>`;
            });
            html += '</tbody></table>';
            
            html += '</div>';
            $('#tablaPatrones').html(html);
        }

        function generarPredicciones() {
            $('#graficoPredicciones').html('<div class="loading">Generando predicciones...</div>');
            
            // Simular datos de ejemplo
            setTimeout(function() {
                const prediccionesEjemplo = {
                    Predicciones: [
                        { Fecha: '2025-01-08', Prediccion: 12 },
                        { Fecha: '2025-01-09', Prediccion: 15 },
                        { Fecha: '2025-01-10', Prediccion: 18 },
                        { Fecha: '2025-01-11', Prediccion: 14 },
                        { Fecha: '2025-01-12', Prediccion: 16 },
                        { Fecha: '2025-01-13', Prediccion: 20 },
                        { Fecha: '2025-01-14', Prediccion: 17 }
                    ]
                };
                crearGraficoPredicciones(prediccionesEjemplo);
            }, 2000);
        }

        function crearGraficoPredicciones(datos) {
            const ctx = document.createElement('canvas');
            $('#graficoPredicciones').html(ctx);
            
            if (chartPredicciones) {
                chartPredicciones.destroy();
            }
            
            chartPredicciones = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datos.Predicciones.map(p => p.Fecha),
                    datasets: [{
                        label: 'Predicción',
                        data: datos.Predicciones.map(p => p.Prediccion),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Predicciones para los próximos 7 días'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }


        function exportarDatos(tipo) {
            // Exportar como imagen JPG
            let canvas = null;
            let nombreArchivo = '';
            
            switch(tipo) {
                case 'prestamos':
                    canvas = chartTendencias?.canvas;
                    nombreArchivo = 'tendencias_prestamos.jpg';
                    break;
                case 'patrones':
                    // Para tablas, crear un canvas temporal
                    exportarTablaComoImagen('tablaPatrones', 'patrones_uso.jpg');
                    return;
                case 'predicciones':
                    canvas = chartPredicciones?.canvas;
                    nombreArchivo = 'predicciones_prestamos.jpg';
                    break;
                default:
                    nombreArchivo = 'datos_exportados.jpg';
            }
            
            if (canvas) {
                // Convertir canvas a imagen JPG
                const link = document.createElement('a');
                link.download = nombreArchivo;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            } else {
                alert('No hay datos para exportar');
            }
        }
        
        function exportarTablaComoImagen(tablaId, nombreArchivo) {
            const tabla = document.getElementById(tablaId);
            if (!tabla) {
                alert('No hay tabla para exportar');
                return;
            }
            
            // Crear un canvas temporal para la tabla
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar el canvas
            canvas.width = tabla.offsetWidth;
            canvas.height = tabla.offsetHeight;
            
            // Estilos para el canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar la tabla como texto (simplificado)
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            
            // Obtener el texto de la tabla
            const texto = tabla.innerText;
            const lineas = texto.split('\n');
            
            let y = 30;
            lineas.forEach(linea => {
                if (linea.trim()) {
                    ctx.fillText(linea, 20, y);
                    y += 20;
                }
            });
            
            // Descargar como JPG
            const link = document.createElement('a');
            link.download = nombreArchivo;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }
    </script>
}