@{
    ViewBag.Title = "Dashboard Estadístico Deportivo";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/estadisticas.css?v=17.0" rel="stylesheet" />
}

<div class="estadisticas-container">
    <!-- Header Principal -->
    <div class="estadisticas-header-index">
        <h1 class="estadisticas-title">@ViewBag.Title</h1>
    </div>

    <!-- Dashboard Principal -->
    <div class="dashboard-principal">
        <div class="filtros-header">
            <div class="filtros-title-group">
                <i class="fas fa-chart-line filtros-icon"></i>
                <h3>Indicadores Clave del Sistema</h3>
            </div>
        </div>
        
        <!-- KPIs Grid -->
        <div class="kpi-grid" id="kpiGrid">
            <div class="kpi-card">
                <div class="kpi-valor" id="prestamosActivos">-</div>
                <div class="kpi-label">Préstamos Activos</div>
                <div class="kpi-variacion" id="variacionPrestamos">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-valor" id="espaciosOcupados">-</div>
                <div class="kpi-label">Espacios Ocupados</div>
                <div class="kpi-variacion" id="variacionEspacios">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-valor" id="tasaDevolucion">-</div>
                <div class="kpi-label">Tasa de Devolución</div>
                <div class="kpi-variacion" id="variacionDevolucion">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-valor" id="usuarioMasActivo">-</div>
                <div class="kpi-label">Usuario Más Activo</div>
                <div class="kpi-variacion" id="variacionUsuario">-</div>
            </div>
        </div>
    </div>

    <!-- Dashboard de Módulos -->
    <div class="dashboard-grid">
        <!-- Análisis de Préstamos -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-hand-holding card-icon"></i>
                Análisis de Préstamos Deportivos
            </h3>
            <div class="card-description">
                Analiza tendencias de préstamos, patrones de uso, predicciones y análisis temporal del material deportivo.
            </div>
            <a href="@Url.Action("Prestamos")" class="card-action">
                <i class="fas fa-chart-line"></i>
                Ver Análisis
            </a>
        </div>

        <!-- Análisis de Espacios -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-building card-icon"></i>
                Análisis de Reservaciones de Espacios
            </h3>
            <div class="card-description">
                Evalúa ocupación de espacios, eficiencia de uso, heatmaps de actividad y patrones de reservación.
            </div>
            <a href="@Url.Action("Espacios")" class="card-action">
                <i class="fas fa-chart-area"></i>
                Ver Análisis
            </a>
        </div>

        <!-- Recomendaciones Inteligentes -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-lightbulb card-icon"></i>
                Recomendaciones Inteligentes
            </h3>
            <div class="card-description">
                Obtén recomendaciones basadas en patrones de uso, horarios óptimos y sugerencias de equipamiento.
            </div>
            <a href="@Url.Action("Recomendaciones")" class="card-action">
                <i class="fas fa-magic"></i>
                Ver Recomendaciones
            </a>
        </div>

        <!-- Análisis Comparativo -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-balance-scale card-icon"></i>
                Análisis Comparativo
            </h3>
            <div class="card-description">
                Compara datos entre diferentes períodos para analizar tendencias, variaciones y cambios temporales.
            </div>
            <a href="@Url.Action("Comparativo")" class="card-action">
                <i class="fas fa-exchange-alt"></i>
                Comparar Períodos
            </a>
        </div>

        <!-- Alertas Estadísticas -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-exclamation-triangle card-icon"></i>
                Alertas Estadísticas
            </h3>
            <div class="card-description">
                Detecta anomalías, patrones inusuales y alertas basadas en desviaciones estadísticas del sistema.
            </div>
            <a href="@Url.Action("Alertas")" class="card-action">
                <i class="fas fa-bell"></i>
                Ver Alertas
            </a>
        </div>

        <!-- Estadísticas de Inventario -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-boxes card-icon"></i>
                Estadísticas de Inventario
            </h3>
            <div class="card-description">
                Analiza stock, movimientos, categorías y tendencias del inventario deportivo.
            </div>
            <a href="@Url.Action("Inventario")" class="card-action">
                <i class="fas fa-chart-bar"></i>
                Ver Estadísticas
            </a>
        </div>

        <!-- Estadísticas de Usuarios -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-users card-icon"></i>
                Estadísticas de Usuarios
            </h3>
            <div class="card-description">
                Evalúa actividad de usuarios, patrones de comportamiento y análisis de participación.
            </div>
            <a href="@Url.Action("Usuarios")" class="card-action">
                <i class="fas fa-user-chart"></i>
                Ver Estadísticas
            </a>
        </div>

        <!-- Estadísticas de Actividad -->
        <div class="dashboard-card">
            <h3>
                <i class="fas fa-server card-icon"></i>
                Estadísticas de Actividad
            </h3>
            <div class="card-description">
                Monitorea actividad general del sistema, logs de acceso y métricas de rendimiento.
            </div>
            <a href="@Url.Action("Actividad")" class="card-action">
                <i class="fas fa-chart-pie"></i>
                Ver Estadísticas
            </a>
        </div>
    </div>

</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Cargar datos del dashboard
            cargarDashboardData();
            cargarKPIs();
            
            // Actualizar datos cada 5 minutos
            setInterval(function() {
                cargarDashboardData();
                cargarKPIs();
            }, 300000);
        });

        function cargarDashboardData() {
            $.get('@Url.Action("DashboardData")', function(response) {
                if (response.success) {
                    var data = response.data;
                    $('#prestamosActivos').text(data.PrestamosActivos || 0);
                    $('#espaciosOcupados').text(data.EspaciosOcupados || 0);
                    $('#tasaDevolucion').text(data.TasaDevolucion + '%' || '0%');
                    $('#usuarioMasActivo').text(data.UsuarioMasActivo || 'N/A');
                }
            }).fail(function() {
                console.log('Error al cargar datos del dashboard');
            });
        }

        function cargarKPIs() {
            $.get('@Url.Action("KPIs")', function(response) {
                if (response.success) {
                    var kpis = response.data;
                    
                    // Actualizar variaciones
                    actualizarVariacion('#variacionPrestamos', kpis.VariacionPrestamos);
                    actualizarVariacion('#variacionEspacios', 0); // No hay datos específicos
                    actualizarVariacion('#variacionDevolucion', kpis.EficienciaDevolucion);
                    actualizarVariacion('#variacionUsuario', 0); // No hay datos específicos
                }
            }).fail(function() {
                console.log('Error al cargar KPIs');
            });
        }


        function actualizarVariacion(selector, valor) {
            var elemento = $(selector);
            if (valor > 0) {
                elemento.text('+' + valor + '%').removeClass('negativa').addClass('positiva');
            } else if (valor < 0) {
                elemento.text(valor + '%').removeClass('positiva').addClass('negativa');
            } else {
                elemento.text('0%').removeClass('positiva negativa');
            }
        }
    </script>
}