@{
    ViewBag.Title = "Análisis de Reservaciones de Espacios";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/estadisticas.css?v=25.0" rel="stylesheet" />
}

<div class="estadisticas-container">
    <!-- Header Principal -->
    <div class="estadisticas-header">
        <div class="header-left">
            <a href="@Url.Action("Index")" class="btn-volver">
                <i class="fas fa-arrow-left"></i>
                Volver a Estadísticas
            </a>
        </div>
        <h1 class="estadisticas-title">@ViewBag.Title</h1>
        <div class="header-actions"></div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="estadisticas-grid">
        <div class="estadistica-card">
            <div class="estadistica-valor" id="totalReservas">-</div>
            <div class="estadistica-label">TOTAL RESERVAS</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="reservasExitosas">-</div>
            <div class="estadistica-label">RESERVAS EXITOSAS</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="tasaOcupacion">-</div>
            <div class="estadistica-label">TASA OCUPACIÓN</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="espaciosUtilizados">-</div>
            <div class="estadistica-label">ESPACIOS UTILIZADOS</div>
        </div>
        <div class="estadistica-card">
            <div class="estadistica-valor" id="horasTotales">-</div>
            <div class="estadistica-label">HORAS TOTALES</div>
        </div>
    </div>

    <!-- Gráfico de Tendencias -->
    <div class="graficos-container">
        <div class="grafico-header">
            <h3 class="grafico-title">Tendencias de Reservaciones</h3>
            <div class="grafico-controls">
                <button class="btn-exportar" onclick="exportarDatos('espacios')">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
        </div>
        <div class="grafico-canvas" id="graficoTendencias">
            <div class="loading">Cargando gráfico de tendencias...</div>
        </div>
    </div>

    <!-- Heatmap de Ocupación -->
    <div class="graficos-container">
        <div class="grafico-header">
            <h3 class="grafico-title">Heatmap de Ocupación</h3>
            <div class="grafico-controls">
                <button class="btn-exportar" onclick="exportarDatos('heatmap')">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
        </div>
        <div class="grafico-canvas" id="graficoHeatmap">
            <div class="loading">Cargando heatmap...</div>
        </div>
    </div>

    <!-- Análisis de Ocupación -->
    <div class="tabla-container">
        <div class="tabla-header">
            <h3 class="tabla-title">Análisis de Ocupación por Espacio</h3>
            <div class="tabla-actions">
                <button class="btn-exportar" onclick="exportarDatos('ocupacion')">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
        </div>
        <div id="tablaOcupacion">
            <div class="loading">Cargando análisis de ocupación...</div>
        </div>
    </div>

    <!-- Análisis de Eficiencia -->
    <div class="tabla-container">
        <div class="tabla-header">
            <h3 class="tabla-title">Eficiencia de Espacios</h3>
            <div class="tabla-actions">
                <button class="btn-exportar" onclick="exportarDatos('eficiencia')">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
        </div>
        <div id="tablaEficiencia">
            <div class="loading">Cargando análisis de eficiencia...</div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartTendencias = null;
        let chartHeatmap = null;

        $(document).ready(function() {
            // Cargar datos iniciales
            cargarTendencias();
            cargarHeatmap();
            cargarOcupacion();
            cargarEficiencia();
            cargarEstadisticasGenerales();
        });

        function cargarTendencias() {
            $('#graficoTendencias').html('<div class="loading">Cargando tendencias...</div>');
            
            // Simular datos de ejemplo
            setTimeout(function() {
                const datosEjemplo = [
                    { Fecha: '2025-01-01', CantidadReservas: 8, EspaciosUtilizados: 5 },
                    { Fecha: '2025-01-02', CantidadReservas: 12, EspaciosUtilizados: 7 },
                    { Fecha: '2025-01-03', CantidadReservas: 15, EspaciosUtilizados: 9 },
                    { Fecha: '2025-01-04', CantidadReservas: 10, EspaciosUtilizados: 6 },
                    { Fecha: '2025-01-05', CantidadReservas: 18, EspaciosUtilizados: 11 },
                    { Fecha: '2025-01-06', CantidadReservas: 14, EspaciosUtilizados: 8 },
                    { Fecha: '2025-01-07', CantidadReservas: 9, EspaciosUtilizados: 5 }
                ];
                crearGraficoTendencias(datosEjemplo);
            }, 1000);
        }

        function crearGraficoTendencias(datos) {
            const ctx = document.createElement('canvas');
            $('#graficoTendencias').html(ctx);
            
            if (chartTendencias) {
                chartTendencias.destroy();
            }
            
            chartTendencias = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datos.map(d => d.Fecha),
                    datasets: [{
                        label: 'Reservas',
                        data: datos.map(d => d.CantidadReservas),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Espacios Utilizados',
                        data: datos.map(d => d.EspaciosUtilizados),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendencias de Reservaciones de Espacios'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function cargarHeatmap() {
            $('#graficoHeatmap').html('<div class="loading">Cargando heatmap...</div>');
            
            // Simular datos de ejemplo
            setTimeout(function() {
                const datosEjemplo = [
                    { DiaSemana: 'Lunes', Hora: 8, Cantidad: 2 },
                    { DiaSemana: 'Lunes', Hora: 14, Cantidad: 5 },
                    { DiaSemana: 'Martes', Hora: 10, Cantidad: 3 },
                    { DiaSemana: 'Martes', Hora: 16, Cantidad: 7 },
                    { DiaSemana: 'Miércoles', Hora: 9, Cantidad: 4 },
                    { DiaSemana: 'Miércoles', Hora: 15, Cantidad: 6 },
                    { DiaSemana: 'Jueves', Hora: 11, Cantidad: 3 },
                    { DiaSemana: 'Jueves', Hora: 17, Cantidad: 8 },
                    { DiaSemana: 'Viernes', Hora: 8, Cantidad: 2 },
                    { DiaSemana: 'Viernes', Hora: 16, Cantidad: 9 }
                ];
                crearGraficoHeatmap(datosEjemplo);
            }, 1500);
        }

        function crearGraficoHeatmap(datos) {
            const ctx = document.createElement('canvas');
            $('#graficoHeatmap').html(ctx);
            
            if (chartHeatmap) {
                chartHeatmap.destroy();
            }
            
            // Crear matriz de datos para el heatmap
            const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const horas = Array.from({length: 24}, (_, i) => i);
            
            // Generar datos más realistas para el heatmap
            const matrizDatos = [];
            diasSemana.forEach((dia, diaIndex) => {
                horas.forEach((hora, horaIndex) => {
                    // Simular patrones de ocupación más realistas
                    let ocupacion = 0;
                    
                    // Horas pico (8-12, 14-18)
                    if ((hora >= 8 && hora <= 12) || (hora >= 14 && hora <= 18)) {
                        ocupacion = Math.random() * 8 + 2; // 2-10
                    }
                    // Horas nocturnas (22-6)
                    else if (hora >= 22 || hora <= 6) {
                        ocupacion = Math.random() * 2; // 0-2
                    }
                    // Horas intermedias
                    else {
                        ocupacion = Math.random() * 4; // 0-4
                    }
                    
                    // Ajustar por día de la semana
                    if (diaIndex >= 5) { // Sábado y Domingo
                        ocupacion *= 1.5;
                    }
                    
                    matrizDatos.push({
                        x: horaIndex,
                        y: diaIndex,
                        v: Math.floor(ocupacion)
                    });
                });
            });
            
            chartHeatmap = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Ocupación',
                        data: matrizDatos,
                        backgroundColor: function(context) {
                            const valor = context.parsed.v;
                            const intensidad = Math.min(valor / 10, 1); // Normalizar a 0-1
                            
                            // Crear gradiente de colores más visible
                            if (intensidad === 0) return 'rgba(240, 240, 240, 0.1)'; // Muy claro
                            if (intensidad <= 0.2) return 'rgba(34, 197, 94, 0.3)'; // Verde claro
                            if (intensidad <= 0.4) return 'rgba(34, 197, 94, 0.5)'; // Verde medio
                            if (intensidad <= 0.6) return 'rgba(34, 197, 94, 0.7)'; // Verde
                            if (intensidad <= 0.8) return 'rgba(34, 197, 94, 0.9)'; // Verde fuerte
                            return 'rgba(34, 197, 94, 1)'; // Verde muy fuerte
                        },
                        borderColor: function(context) {
                            const valor = context.parsed.v;
                            const intensidad = Math.min(valor / 10, 1);
                            return intensidad > 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(200, 200, 200, 0.3)';
                        },
                        borderWidth: 1,
                        pointRadius: 12,
                        pointHoverRadius: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Heatmap de Ocupación por Día y Hora',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                generateLabels: function(chart) {
                                    return [{
                                        text: 'Ocupación',
                                        fillStyle: 'rgba(34, 197, 94, 0.7)',
                                        strokeStyle: 'rgba(34, 197, 94, 0.8)',
                                        lineWidth: 1
                                    }];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const punto = context[0];
                                    const dia = diasSemana[punto.parsed.y];
                                    const hora = punto.parsed.x;
                                    return `${dia} - ${hora}:00`;
                                },
                                label: function(context) {
                                    return `Ocupación: ${context.parsed.v} espacios`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Hora del Día',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: -0.5,
                            max: 23.5,
                            ticks: {
                                stepSize: 2,
                                callback: function(value) {
                                    return value + ':00';
                                },
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Día de la Semana',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: -0.5,
                            max: 6.5,
                            ticks: {
                                callback: function(value) {
                                    return diasSemana[value];
                                },
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function cargarOcupacion() {
            $('#tablaOcupacion').html('<div class="loading">Cargando análisis de ocupación...</div>');
            
            // Simular datos de ejemplo
            setTimeout(function() {
                const datosEjemplo = [
                    { NombreEspacio: 'Cancha de Fútbol', Capacidad: 22, TotalReservas: 45, HorasReservadas: 90, PorcentajeOcupacion: 75, Estado: 'Activo' },
                    { NombreEspacio: 'Cancha de Basketball', Capacidad: 10, TotalReservas: 32, HorasReservadas: 64, PorcentajeOcupacion: 80, Estado: 'Activo' },
                    { NombreEspacio: 'Gimnasio', Capacidad: 20, TotalReservas: 28, HorasReservadas: 56, PorcentajeOcupacion: 60, Estado: 'Activo' },
                    { NombreEspacio: 'Piscina', Capacidad: 15, TotalReservas: 18, HorasReservadas: 36, PorcentajeOcupacion: 45, Estado: 'Mantenimiento' }
                ];
                mostrarOcupacion(datosEjemplo);
            }, 1200);
        }

        function mostrarOcupacion(datos) {
            let html = '<table class="tabla-datos"><thead><tr><th>Espacio</th><th>Capacidad</th><th>Reservas</th><th>Horas Reservadas</th><th>% Ocupación</th><th>Estado</th></tr></thead><tbody>';
            
            datos.forEach(d => {
                html += `<tr>
                    <td>${d.NombreEspacio}</td>
                    <td>${d.Capacidad}</td>
                    <td>${d.TotalReservas}</td>
                    <td>${d.HorasReservadas}</td>
                    <td>${d.PorcentajeOcupacion}%</td>
                    <td>${d.Estado}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            $('#tablaOcupacion').html(html);
        }

        function cargarEficiencia() {
            $('#tablaEficiencia').html('<div class="loading">Cargando análisis de eficiencia...</div>');
            
            // Simular datos de ejemplo
            setTimeout(function() {
                const datosEjemplo = [
                    { NombreEspacio: 'Cancha de Fútbol', Capacidad: 22, TotalReservas: 45, ReservasExitosas: 42, TasaExito: 93, HorasTotales: 90, UsuariosUnicos: 35, Eficiencia: 0.85 },
                    { NombreEspacio: 'Cancha de Basketball', Capacidad: 10, TotalReservas: 32, ReservasExitosas: 30, TasaExito: 94, HorasTotales: 64, UsuariosUnicos: 25, Eficiencia: 0.90 },
                    { NombreEspacio: 'Gimnasio', Capacidad: 20, TotalReservas: 28, ReservasExitosas: 26, TasaExito: 93, HorasTotales: 56, UsuariosUnicos: 22, Eficiencia: 0.78 },
                    { NombreEspacio: 'Piscina', Capacidad: 15, TotalReservas: 18, ReservasExitosas: 16, TasaExito: 89, HorasTotales: 36, UsuariosUnicos: 14, Eficiencia: 0.72 }
                ];
                mostrarEficiencia(datosEjemplo);
            }, 1800);
        }

        function mostrarEficiencia(datos) {
            let html = '<table class="tabla-datos"><thead><tr><th>Espacio</th><th>Capacidad</th><th>Reservas</th><th>Exitosas</th><th>Tasa Éxito</th><th>Horas Totales</th><th>Usuarios Únicos</th><th>Eficiencia</th></tr></thead><tbody>';
            
            datos.forEach(d => {
                html += `<tr>
                    <td>${d.NombreEspacio}</td>
                    <td>${d.Capacidad}</td>
                    <td>${d.TotalReservas}</td>
                    <td>${d.ReservasExitosas}</td>
                    <td>${d.TasaExito}%</td>
                    <td>${d.HorasTotales}</td>
                    <td>${d.UsuariosUnicos}</td>
                    <td>${(d.Eficiencia * 100).toFixed(1)}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            $('#tablaEficiencia').html(html);
        }

        function cargarEstadisticasGenerales() {
            // Simular datos de ejemplo para las estadísticas generales
            setTimeout(function() {
                $('#totalReservas').text('123');
                $('#reservasExitosas').text('115');
                $('#tasaOcupacion').text('78%');
                $('#espaciosUtilizados').text('4');
                $('#horasTotales').text('246');
            }, 500);
        }
        
        function exportarDatos(tipo) {
            // Exportar como imagen JPG
            let canvas = null;
            let nombreArchivo = '';
            
            switch(tipo) {
                case 'espacios':
                    canvas = chartTendencias?.canvas;
                    nombreArchivo = 'tendencias_espacios.jpg';
                    break;
                case 'heatmap':
                    canvas = chartHeatmap?.canvas;
                    nombreArchivo = 'heatmap_ocupacion.jpg';
                    break;
                case 'ocupacion':
                    exportarTablaComoImagen('tablaOcupacion', 'ocupacion_espacios.jpg');
                    return;
                case 'eficiencia':
                    exportarTablaComoImagen('tablaEficiencia', 'eficiencia_espacios.jpg');
                    return;
                default:
                    nombreArchivo = 'datos_exportados.jpg';
            }
            
            if (canvas) {
                // Convertir canvas a imagen JPG
                const link = document.createElement('a');
                link.download = nombreArchivo;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            } else {
                alert('No hay datos para exportar');
            }
        }
        
        function exportarTablaComoImagen(tablaId, nombreArchivo) {
            const tabla = document.getElementById(tablaId);
            if (!tabla) {
                alert('No hay tabla para exportar');
                return;
            }
            
            // Crear un canvas temporal para la tabla
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar el canvas
            canvas.width = tabla.offsetWidth;
            canvas.height = tabla.offsetHeight;
            
            // Estilos para el canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar la tabla como texto (simplificado)
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            
            // Obtener el texto de la tabla
            const texto = tabla.innerText;
            const lineas = texto.split('\n');
            
            let y = 30;
            lineas.forEach(linea => {
                if (linea.trim()) {
                    ctx.fillText(linea, 20, y);
                    y += 20;
                }
            });
            
            // Descargar como JPG
            const link = document.createElement('a');
            link.download = nombreArchivo;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }
    </script>
}